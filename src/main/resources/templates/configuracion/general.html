<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/layout :: head}"></div>
    <title>Configuración General</title>
    <style>
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            border: 2px solid #ddd;
            cursor: pointer;
        }
        .color-demo-card {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .tab-content {
            padding-top: 20px;
        }
        .logo-preview {
            max-width: 200px;
            max-height: 200px;
            border: 2px dashed #ddd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <aside th:replace="~{fragments/layout :: sidebar(active='configuracion')}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-cogs"></i> Configuración General del Sistema</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                            <li class="breadcrumb-item active">Configuración</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-check"></i> <span th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                </div>

                <div class="card card-primary card-outline card-tabs">
                    <div class="card-header p-0 pt-1 border-bottom-0">
                        <ul class="nav nav-tabs" id="custom-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="tab-empresa" data-toggle="pill" href="#empresa" role="tab">
                                    <i class="fas fa-building"></i> Datos de Empresa
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-visual" data-toggle="pill" href="#visual" role="tab">
                                    <i class="fas fa-palette"></i> Personalización Visual
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-reportes" data-toggle="pill" href="#reportes" role="tab">
                                    <i class="fas fa-file-pdf"></i> Configuración de Reportes
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-sistema" data-toggle="pill" href="#sistema" role="tab">
                                    <i class="fas fa-sliders-h"></i> Configuración de Sistema
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body">
                        <form id="formConfiguracion" th:action="@{/configuracion/general/guardar}" method="post"
                              enctype="multipart/form-data" th:object="${config}">

                            <input type="hidden" th:field="*{id}">

                            <div class="tab-content" id="custom-tabs-content">

                                <div class="tab-pane fade show active" id="empresa" role="tabpanel">
                                    <h4 class="mb-3"><i class="fas fa-building text-primary"></i> Información de la Empresa</h4>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Logo de la Empresa</label>
                                                <div class="text-center mb-3">
                                                    <img th:if="${config.logoBase64 != null}"
                                                         th:src="'data:image/png;base64,' + ${config.logoBase64}"
                                                         class="logo-preview" id="logoPreview" alt="Logo">
                                                    <div th:if="${config.logoBase64 == null}" class="logo-preview d-flex align-items-center justify-content-center">
                                                        <span class="text-muted">Sin logo</span>
                                                    </div>
                                                </div>
                                                <input type="file" class="form-control-file" name="fileLogo" id="fileLogo" accept="image/*" onchange="previewLogo(this)">
                                                <small class="form-text text-muted">Formatos: PNG, JPG. Máx: 2MB</small>
                                            </div>
                                        </div>

                                        <div class="col-md-8">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Nombre de la Empresa <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" th:field="*{nombreEmpresa}" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>RUC <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" th:field="*{ruc}" maxlength="11" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label>Slogan</label>
                                                <input type="text" class="form-control" th:field="*{slogan}" placeholder="Tu empresa de confianza">
                                            </div>

                                            <div class="form-group">
                                                <label>Dirección <span class="text-danger">*</span></label>
                                                <textarea class="form-control" th:field="*{direccion}" rows="2" required></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>
                                    <h5 class="mt-3"><i class="fas fa-phone text-info"></i> Datos de Contacto</h5>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Teléfono</label>
                                                <input type="text" class="form-control" th:field="*{telefono}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Email</label>
                                                <input type="email" class="form-control" th:field="*{email}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Sitio Web</label>
                                                <input type="text" class="form-control" th:field="*{webSite}" placeholder="https://www.miempresa.com">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label><i class="fab fa-facebook text-primary"></i> Facebook</label>
                                                <input type="text" class="form-control" th:field="*{facebook}" placeholder="@miempresa">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label><i class="fab fa-instagram text-danger"></i> Instagram</label>
                                                <input type="text" class="form-control" th:field="*{instagram}" placeholder="@miempresa">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label><i class="fab fa-whatsapp text-success"></i> WhatsApp</label>
                                                <input type="text" class="form-control" th:field="*{whatsapp}" placeholder="+51 999 999 999">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label><i class="fas fa-clock text-warning"></i> Horario</label>
                                                <input type="text" class="form-control" th:field="*{horarioAtencion}" placeholder="Lun-Vie: 9am-7pm">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="visual" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h4 class="mb-3"><i class="fas fa-palette text-primary"></i> Colores Personalizados</h4>

                                            <div class="alert alert-info">
                                                <i class="icon fas fa-info-circle"></i>
                                                Personalice los colores del sistema. Los cambios se aplicarán en toda la interfaz.
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Primario</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorPrimario}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorPrimario}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Secundario</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorSecundario}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorSecundario}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Éxito</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorExito}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorExito}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Peligro</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorPeligro}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorPeligro}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Advertencia</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorAdvertencia}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorAdvertencia}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Información</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorInfo}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorInfo}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Color Bronce (Medalla 3er lugar)</label>
                                                        <div class="input-group">
                                                            <input type="color" class="form-control color-preview" th:field="*{colorBronce}" onchange="updatePreview()">
                                                            <input type="text" class="form-control" th:field="*{colorBronce}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <button type="button" class="btn btn-warning btn-block" onclick="restaurarColores()">
                                                <i class="fas fa-undo"></i> Restaurar Colores por Defecto
                                            </button>
                                        </div>

                                        <div class="col-md-6">
                                            <h4 class="mb-3"><i class="fas fa-eye text-success"></i> Vista Previa</h4>

                                            <div id="colorPreview">
                                                <p><strong>Botones:</strong></p>
                                                <button type="button" class="btn btn-sm btn-primary mb-2" style="background-color: var(--color-primario, #007bff)">Primario</button>
                                                <button type="button" class="btn btn-sm btn-success mb-2" style="background-color: var(--color-exito, #28a745)">Éxito</button>
                                                <button type="button" class="btn btn-sm btn-danger mb-2" style="background-color: var(--color-peligro, #dc3545)">Peligro</button>
                                                <button type="button" class="btn btn-sm btn-warning mb-2" style="background-color: var(--color-advertencia, #ffc107)">Advertencia</button>
                                                <button type="button" class="btn btn-sm btn-info mb-2" style="background-color: var(--color-info, #17a2b8)">Info</button>

                                                <p class="mt-3"><strong>Badges:</strong></p>
                                                <span class="badge badge-primary" style="background-color: var(--color-primario, #007bff)">Primario</span>
                                                <span class="badge badge-success" style="background-color: var(--color-exito, #28a745)">Éxito</span>
                                                <span class="badge badge-danger" style="background-color: var(--color-peligro, #dc3545)">Peligro</span>
                                                <span class="badge badge-warning" style="background-color: var(--color-advertencia, #ffc107)">Advertencia</span>
                                                <span class="badge badge-info" style="background-color: var(--color-info, #17a2b8)">Info</span>

                                                <p class="mt-3"><strong>Alertas:</strong></p>
                                                <div class="alert alert-primary" role="alert" style="background-color: var(--color-primario, #007bff); color: white; border: none;">
                                                    Alerta primaria - Color principal de la marca
                                                </div>
                                                <div class="alert alert-success" role="alert" style="background-color: var(--color-exito, #28a745); color: white; border: none;">
                                                    Alerta de éxito - Operación completada
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="reportes" role="tabpanel">
                                    <h4 class="mb-3"><i class="fas fa-file-pdf text-danger"></i> Personalización de Reportes PDF</h4>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <div class="custom-control custom-switch custom-switch-lg">
                                                    <input type="checkbox" class="custom-control-input" th:field="*{mostrarLogoEnReportes}" id="mostrarLogo">
                                                    <label class="custom-control-label" for="mostrarLogo">
                                                        Mostrar Logo en Reportes
                                                    </label>
                                                </div>
                                                <small class="form-text text-muted">El logo aparecerá en el encabezado de los PDFs</small>
                                            </div>

                                            <div class="form-group">
                                                <label>Formato de Fecha en Reportes</label>
                                                <select class="form-control" th:field="*{formatoFechaReportes}">
                                                    <option value="dd/MM/yyyy">DD/MM/AAAA (31/12/2025)</option>
                                                    <option value="MM/dd/yyyy">MM/DD/AAAA (12/31/2025)</option>
                                                    <option value="yyyy-MM-dd">AAAA-MM-DD (2025-12-31)</option>
                                                    <option value="dd-MM-yyyy">DD-MM-AAAA (31-12-2025)</option>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label>Símbolo de Moneda</label>
                                                <input type="text" class="form-control" th:field="*{formatoMoneda}" placeholder="S/" maxlength="5">
                                                <small class="form-text text-muted">Ej: S/, $, €, USD</small>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Encabezado Personalizado de Reportes</label>
                                                <textarea class="form-control" th:field="*{encabezadoReportes}" rows="3"
                                                          placeholder="Documento generado automáticamente"></textarea>
                                                <small class="form-text text-muted">Texto que aparecerá en la parte superior del reporte</small>
                                            </div>

                                            <div class="form-group">
                                                <label>Pie de Página de Reportes</label>
                                                <textarea class="form-control" th:field="*{piePaginaReportes}" rows="3"
                                                          placeholder="Gracias por su preferencia"></textarea>
                                                <small class="form-text text-muted">Texto que aparecerá al final del reporte</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="sistema" role="tabpanel">
                                    <h4 class="mb-3"><i class="fas fa-sliders-h text-warning"></i> Parámetros del Sistema</h4>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="text-primary">Configuración de Interfaz</h5>

                                            <div class="form-group">
                                                <label>Items por Página en Tablas</label>
                                                <input type="number" class="form-control" th:field="*{itemsPorPagina}" min="5" max="100">
                                                <small class="form-text text-muted">Cantidad de registros mostrados en las tablas (5-100)</small>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <h5 class="text-success">Configuración de Inventario</h5>

                                            <div class="form-group">
                                                <label>Stock Mínimo para Alertas</label>
                                                <input type="number" class="form-control" th:field="*{stockMinimo}" min="1">
                                                <small class="form-text text-muted">Se mostrará alerta cuando el stock esté por debajo de este valor</small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="text-info">Configuración de Ventas</h5>

                                            <div class="form-group">
                                                <label>Días de Vencimiento para Créditos</label>
                                                <input type="number" class="form-control" th:field="*{diasVencimientoCredito}" min="1">
                                                <small class="form-text text-muted">Días por defecto para el vencimiento de ventas a crédito</small>
                                            </div>

                                            <div class="form-group">
                                                <label>Días para Devoluciones</label>
                                                <input type="number" class="form-control" th:field="*{diasDevolucion}" min="1">
                                                <small class="form-text text-muted">Período permitido para procesar devoluciones</small>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <h5 class="text-danger">Configuración Fiscal</h5>

                                            <div class="form-group">
                                                <label>Porcentaje de IGV (%)</label>
                                                <input type="number" step="0.01" class="form-control" th:field="*{igvPorcentaje}" min="0" max="100">
                                                <small class="form-text text-muted">Porcentaje de IGV aplicado a las ventas (Perú: 18%)</small>
                                            </div>

                                            <div class="alert alert-warning mt-3">
                                                <i class="icon fas fa-exclamation-triangle"></i>
                                                <strong>Importante:</strong> Cambiar el IGV afectará los cálculos de nuevas ventas.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="card-footer">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary btn-lg btn-block">
                                            <i class="fas fa-save"></i> Guardar Configuración
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <a href="/" class="btn btn-secondary btn-lg btn-block">
                                            <i class="fas fa-times"></i> Cancelar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script>
    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logoPreview').src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function updatePreview() {
        const root = document.documentElement;
        root.style.setProperty('--color-primario', document.getElementById('colorPrimario').value);
        root.style.setProperty('--color-exito', document.getElementById('colorExito').value);
        root.style.setProperty('--color-peligro', document.getElementById('colorPeligro').value);
        root.style.setProperty('--color-advertencia', document.getElementById('colorAdvertencia').value);
        root.style.setProperty('--color-info', document.getElementById('colorInfo').value);
    }

    function restaurarColores() {
        if (!confirm('¿Está seguro de restaurar los colores por defecto? Se perderá la personalización actual.')) {
            return;
        }

        fetch('/configuracion/general/colores-default', {
            method: 'POST'
        })
        .then(response => response.text())
        .then(data => {
            alert(data);
            location.reload();
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    // Inicializar vista previa y tabs al cargar
    $(document).ready(function() {
        // Inicializar vista previa de colores
        updatePreview();

        // Activar tabs de Bootstrap (asegurar que funcionan correctamente)
        $('#custom-tabs a[data-toggle="pill"]').on('click', function (e) {
            e.preventDefault();
            $(this).tab('show');
        });

        // Si hay un hash en la URL, activar ese tab
        var hash = window.location.hash;
        if (hash) {
            $('#custom-tabs a[href="' + hash + '"]').tab('show');
        }
    });
</script>
</body>
</html>