<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <div th:replace="~{fragments/layout :: head}"></div>
    <title>Configuraci√≥n SUNAT</title>
    <style>
        /* Toggle Switch Grande */
        .custom-switch-lg .custom-control-label::before {
            height: 2.5rem;
            width: 4.5rem;
            border-radius: 3rem;
        }
        .custom-switch-lg .custom-control-label::after {
            width: 2rem;
            height: 2rem;
            border-radius: 2rem;
        }
        .custom-switch-lg .custom-control-input:checked ~ .custom-control-label::after {
            transform: translateX(2rem);
        }

        /* Badge grande */
        .badge-lg {
            font-size: 1.1rem;
            padding: 0.5rem 1rem;
        }

        /* Callout personalizado */
        .callout-info {
            border-left-color: #17a2b8;
            background-color: #d1ecf1;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <aside th:replace="~{fragments/layout :: sidebar(active='configuracion')}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-file-invoice text-primary"></i> Configuraci√≥n SUNAT</h1>
                        <p class="text-muted mb-0">Facturaci√≥n Electr√≥nica</p>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="/configuracion/general">Configuraci√≥n</a></li>
                            <li class="breadcrumb-item active">SUNAT</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-check"></i> <span th:text="${success}"></span>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                </div>

                <div class="card card-outline" th:classappend="${isActiva ? 'card-success' : 'card-secondary'}">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold">
                            <i class="fas fa-power-off"></i> Control de Facturaci√≥n Electr√≥nica
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <div class="d-flex align-items-center">
                                    <div class="custom-control custom-switch custom-switch-lg mr-3">
                                        <input type="checkbox" class="custom-control-input" id="toggleSwitch"
                                               th:checked="${isActiva}"
                                               th:disabled="${!configCompleta}"
                                               onchange="toggleFacturacion()">
                                        <label class="custom-control-label" for="toggleSwitch"></label>
                                    </div>

                                    <div>
                                        <h4 class="mb-1">
                                            <span th:if="${isActiva}" class="badge badge-success badge-lg">
                                                <i class="fas fa-check-circle"></i> ACTIVA
                                            </span>
                                            <span th:unless="${isActiva}" class="badge badge-secondary badge-lg">
                                                <i class="fas fa-times-circle"></i> INACTIVA
                                            </span>
                                        </h4>
                                        <p class="text-muted mb-0 small" th:if="${isActiva}">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            Los comprobantes se env√≠an autom√°ticamente a SUNAT
                                        </p>
                                        <p class="text-muted mb-0 small" th:unless="${isActiva}">
                                            <i class="fas fa-file-alt"></i>
                                            Modo interno - Sin env√≠o a SUNAT
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-7 text-right">
                                <button type="button" class="btn btn-info btn-lg"
                                        onclick="sincronizarSunat()"
                                        th:if="${isActiva}"
                                        id="btnSincronizar">
                                    <i class="fas fa-sync-alt"></i> Sincronizar con SUNAT
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ml-2"
                                        onclick="testConexion()"
                                        id="btnTest">
                                    <i class="fas fa-plug"></i> Test de Conexi√≥n
                                </button>
                            </div>
                        </div>

                        <hr class="mt-3 mb-3">

                        <div th:if="${!configCompleta}" class="alert alert-warning alert-dismissible">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            <h5><i class="icon fas fa-exclamation-triangle"></i> Configuraci√≥n Incompleta</h5>
                            <p class="mb-0">
                                Para activar la facturaci√≥n electr√≥nica, primero debe completar la configuraci√≥n abajo.
                                Expanda el formulario y complete todos los campos requeridos (*).
                            </p>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="callout callout-info">
                                    <h6><i class="fas fa-info-circle"></i> Series de Comprobantes:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Series Oficiales SUNAT:</strong>
                                            <ul class="mb-0">
                                                <li>Boletas: <code>B001</code> (Producci√≥n)</li>
                                                <li>Facturas: <code>F001</code> (Producci√≥n)</li>
                                            </ul>
                                            <small class="text-muted">Usadas cuando est√° activa la facturaci√≥n electr√≥nica</small>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Series Internas:</strong>
                                            <ul class="mb-0">
                                                <li>Boletas: <code>I001</code></li>
                                                <li>Facturas: <code>IF001</code></li>
                                            </ul>
                                            <small class="text-muted">Usadas cuando est√° inactiva la facturaci√≥n electr√≥nica</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-building"></i> Datos del Emisor y Configuraci√≥n API
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>

                    <form id="formConfiguracion" th:action="@{/configuracion/sunat/guardar}"
                          th:object="${config}" method="post" onsubmit="return validarFormulario(event)">
                        
                        <input type="hidden" th:field="*{id}">
                        <input type="hidden" th:field="*{facturaElectronicaActiva}">

                        <div class="card-body">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="fas fa-building"></i> Datos del Emisor (Su Empresa)
                            </h5>

                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="rucEmisor">RUC Emisor <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="rucEmisor"
                                               th:field="*{rucEmisor}" maxlength="11" required
                                               pattern="[0-9]{11}" placeholder="20123456789"
                                               oninput="validarRUC(this)">
                                        <small class="form-text text-muted"><i class="fas fa-info-circle"></i> Exactamente 11 d√≠gitos num√©ricos</small>
                                        <span class="error-message text-danger small" id="errorRuc"></span>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="razonSocial">Raz√≥n Social <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="razonSocial"
                                               th:field="*{razonSocialEmisor}" required
                                               placeholder="EMPRESA DEMO S.A.C.">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="nombreComercial">Nombre Comercial</label>
                                        <input type="text" class="form-control" id="nombreComercial"
                                               th:field="*{nombreComercial}" placeholder="Librer√≠a Demo">
                                        <small class="form-text text-muted">Opcional</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="ubigeo">Ubigeo <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="ubigeo"
                                               th:field="*{ubigeoEmisor}" maxlength="6"
                                               pattern="[0-9]{6}" placeholder="150101"
                                               oninput="validarUbigeo(this)">
                                        <small class="form-text text-muted"><i class="fas fa-info-circle"></i> 6 d√≠gitos (ej: 150101 = Lima-Lima-Lima)</small>
                                        <span class="error-message text-danger small" id="errorUbigeo"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="direccion">Direcci√≥n Fiscal <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="direccion"
                                               th:field="*{direccionFiscal}" required
                                               placeholder="AV. LOS OLIVOS 123, LIMA">
                                    </div>
                                </div>
                            </div>

                            <h5 class="text-primary border-bottom pb-2 mt-4">
                                <i class="fas fa-cloud"></i> Configuraci√≥n del PSE (APISUNAT)
                            </h5>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="urlApi">URL API SUNAT <span class="text-danger">*</span></label>
                                        <select class="form-control" id="urlApi" th:field="*{urlApiSunat}" required>
                                            <option value="">-- Seleccione Ambiente --</option>
                                            <option value="https://app.apisunat.pe/api/test/documents">üß™ Test (Pruebas sin costo)</option>
                                            <option value="https://sandbox.apisunat.pe/api/v3/documents">üöÄ Producci√≥n (Real - con costo)</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                            <strong>Test:</strong> Pruebas gratuitas sin cargo | <strong>Producci√≥n:</strong> Comprobantes reales con costo
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="token">Token API SUNAT <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="token"
                                                   th:field="*{tokenApiSunat}" required
                                                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                                    <i class="fas fa-eye" id="iconEye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted"><i class="fas fa-key"></i> Token obtenido desde el panel de APISUNAT</small>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info alert-dismissible">
                                <button type="button" class="close" data-dismiss="alert">&times;</button>
                                <h5><i class="icon fas fa-info-circle"></i> Informaci√≥n Importante:</h5>
                                <ul class="mb-0">
                                    <li><strong>Test:</strong> Pruebas sin costo. Los comprobantes NO se env√≠an a SUNAT oficial.</li>
                                    <li><strong>Producci√≥n:</strong> Comprobantes reales con costo enviados a SUNAT oficial.</li>
                                    <li>Al <strong>activar</strong> facturaci√≥n electr√≥nica, los correlativos se sincronizar√°n autom√°ticamente.</li>
                                    <li>Todas las ventas con <strong>BOLETA</strong> o <strong>FACTURA</strong> se enviar√°n autom√°ticamente.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                            </button>
                            <a href="/" class="btn btn-default btn-lg ml-2">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>

            </div>
        </section>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script>
    // ==================== VALIDACIONES ====================

    function validarRUC(input) {
        const valor = input.value.replace(/\D/g, ''); // Solo n√∫meros
        input.value = valor;

        const errorSpan = document.getElementById('errorRuc');
        if (valor.length > 0 && valor.length !== 11) {
            errorSpan.textContent = '‚ùå El RUC debe tener exactamente 11 d√≠gitos';
            input.classList.add('is-invalid');
        } else {
            errorSpan.textContent = '';
            input.classList.remove('is-invalid');
            if (valor.length === 11) {
                input.classList.add('is-valid');
            } else {
                input.classList.remove('is-valid');
            }
        }
    }

    function validarUbigeo(input) {
        const valor = input.value.replace(/\D/g, ''); // Solo n√∫meros
        input.value = valor;

        const errorSpan = document.getElementById('errorUbigeo');
        if (valor.length > 0 && valor.length !== 6) {
            errorSpan.textContent = '‚ùå El Ubigeo debe tener exactamente 6 d√≠gitos';
            input.classList.add('is-invalid');
        } else {
            errorSpan.textContent = '';
            input.classList.remove('is-invalid');
            if (valor.length === 6) {
                input.classList.add('is-valid');
            } else {
                input.classList.remove('is-valid');
            }
        }
    }

    function validarFormulario(event) {
        const ruc = document.getElementById('rucEmisor').value;
        const ubigeo = document.getElementById('ubigeo').value;

        if (ruc.length !== 11) {
            Swal.fire({
                icon: 'error',
                title: 'Error de Validaci√≥n',
                text: 'El RUC debe tener exactamente 11 d√≠gitos',
                confirmButtonColor: '#d33'
            });
            event.preventDefault();
            return false;
        }

        if (ubigeo && ubigeo.length !== 6) {
            Swal.fire({
                icon: 'error',
                title: 'Error de Validaci√≥n',
                text: 'El Ubigeo debe tener exactamente 6 d√≠gitos',
                confirmButtonColor: '#d33'
            });
            event.preventDefault();
            return false;
        }

        return true;
    }

    function togglePassword() {
        const input = document.getElementById('token');
        const icon = document.getElementById('iconEye');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // ==================== TOGGLE FACTURACI√ìN ====================

    function toggleFacturacion() {
        const checkbox = document.getElementById('toggleSwitch');
        const nuevoEstado = checkbox.checked;

        // Validar que el checkbox no est√© deshabilitado (por si acaso)
        if (checkbox.disabled) {
            Swal.fire({
                icon: 'warning',
                title: 'Configuraci√≥n Incompleta',
                html: '<p>Debe completar la configuraci√≥n de SUNAT antes de activar la facturaci√≥n electr√≥nica.</p>' +
                      '<p class="mt-3">Por favor, expanda el formulario abajo y complete:</p>' +
                      '<ul class="text-left">' +
                      '<li>RUC Emisor</li>' +
                      '<li>Raz√≥n Social</li>' +
                      '<li>Direcci√≥n Fiscal</li>' +
                      '<li>URL API SUNAT</li>' +
                      '<li>Token API</li>' +
                      '</ul>',
                confirmButtonColor: '#ffc107',
                confirmButtonText: 'Entendido'
            });
            checkbox.checked = !nuevoEstado;
            return;
        }

        const titulo = nuevoEstado ? 'Activar Facturaci√≥n Electr√≥nica' : 'Desactivar Facturaci√≥n Electr√≥nica';
        const texto = nuevoEstado
            ? 'Se sincronizar√°n los correlativos con SUNAT y todas las ventas (Boletas/Facturas) se enviar√°n autom√°ticamente.'
            : 'Las ventas volver√°n a usar series internas (I001/IF001) sin env√≠o a SUNAT.';

        Swal.fire({
            title: titulo,
            text: texto,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: nuevoEstado ? '#28a745' : '#ffc107',
            cancelButtonColor: '#6c757d',
            confirmButtonText: nuevoEstado ? 'S√≠, Activar' : 'S√≠, Desactivar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                ejecutarToggle(nuevoEstado);
            } else {
                // Revertir checkbox
                checkbox.checked = !nuevoEstado;
            }
        });
    }

    function ejecutarToggle(nuevoEstado) {
        Swal.fire({
            title: 'Procesando...',
            text: 'Actualizando configuraci√≥n',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/configuracion/sunat/toggle?activo=' + nuevoEstado, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(text || 'Error en el servidor');
                });
            }
            return response.text();
        })
        .then(data => {
            Swal.fire({
                icon: 'success',
                title: nuevoEstado ? 'Facturaci√≥n Activada' : 'Facturaci√≥n Desactivada',
                text: data,
                confirmButtonColor: '#28a745'
            }).then(() => {
                location.reload();
            });
        })
        .catch(error => {
            let mensajeError = error.message;

            // Detectar si falta configuraci√≥n
            if (mensajeError.includes('configurar SUNAT')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Configuraci√≥n Incompleta',
                    html: '<p>Debe completar la configuraci√≥n de SUNAT antes de activar la facturaci√≥n electr√≥nica.</p>' +
                          '<p class="mt-3">Por favor, expanda el formulario abajo y complete:</p>' +
                          '<ul class="text-left">' +
                          '<li>RUC Emisor</li>' +
                          '<li>Raz√≥n Social</li>' +
                          '<li>Direcci√≥n Fiscal</li>' +
                          '<li>URL API SUNAT</li>' +
                          '<li>Token API</li>' +
                          '</ul>',
                    confirmButtonColor: '#ffc107',
                    confirmButtonText: 'Entendido'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: mensajeError,
                    confirmButtonColor: '#d33'
                });
            }

            // Revertir checkbox
            document.getElementById('toggleSwitch').checked = !nuevoEstado;
        });
    }

    // ==================== SINCRONIZAR SUNAT ====================

    function sincronizarSunat() {
        Swal.fire({
            title: 'Sincronizar con SUNAT',
            html: 'Se consultar√° el √∫ltimo n√∫mero usado de cada serie oficial:<br><br>' +
                  '<strong>B001</strong> (Boletas)<br>' +
                  '<strong>F001</strong> (Facturas)<br><br>' +
                  'Los correlativos locales se actualizar√°n autom√°ticamente.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#17a2b8',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-sync-alt"></i> Sincronizar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                ejecutarSincronizacion();
            }
        });
    }

    function ejecutarSincronizacion() {
        Swal.fire({
            title: 'Sincronizando...',
            text: 'Consultando APISUNAT',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/configuracion/sunat/sincronizar', {
            method: 'POST'
        })
        .then(response => response.text())
        .then(data => {
            Swal.fire({
                icon: 'success',
                title: 'Sincronizaci√≥n Completada',
                html: '<pre class="text-left">' + data + '</pre>',
                confirmButtonColor: '#28a745',
                width: '600px'
            });
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error de Sincronizaci√≥n',
                text: error.toString(),
                confirmButtonColor: '#d33'
            });
        });
    }

    // ==================== TEST DE CONEXI√ìN ====================

    function testConexion() {
        Swal.fire({
            title: 'Probando Conexi√≥n...',
            text: 'Verificando configuraci√≥n y conectividad',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/configuracion/sunat/test-conexion', {
            method: 'POST'
        })
        .then(response => response.text())
        .then(data => {
            const esError = data.startsWith('ERROR');
            Swal.fire({
                icon: esError ? 'error' : 'success',
                title: esError ? 'Test Fallido' : 'Test Exitoso',
                text: data,
                confirmButtonColor: esError ? '#d33' : '#28a745'
            });
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error de Conexi√≥n',
                text: 'No se pudo conectar con el servidor: ' + error,
                confirmButtonColor: '#d33'
            });
        });
    }
</script>

</body>
</html>