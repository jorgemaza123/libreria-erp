<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='sunat')}"></aside>

    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-file-invoice text-purple"></i> Facturacion SUNAT</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="/configuracion/general">Configuracion</a></li>
                            <li class="breadcrumb-item active">Facturacion SUNAT</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">

                <!-- Alerta de Deuda -->
                <div th:if="${not #lists.isEmpty(deudas)}" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <h5><i class="fas fa-exclamation-triangle"></i> Deuda Pendiente</h5>
                    <p>Tiene <strong th:text="${#lists.size(deudas)}">0</strong> mes(es) con pago pendiente.
                       Total: <strong th:text="'S/ ' + ${resumen.deudaTotal}">S/ 0.00</strong></p>
                </div>

                <!-- Toggle SUNAT -->
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-power-off"></i> Estado del Servicio SUNAT</h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <p class="mb-0">
                                    <strong>Facturacion Electronica:</strong>
                                    Cuando esta activo, las boletas y facturas se envian a SUNAT.
                                </p>
                                <small class="text-muted">Los primeros 20 comprobantes de cada mes son GRATIS.</small>
                            </div>
                            <div class="col-md-4 text-right">
                                <div class="custom-control custom-switch custom-switch-lg">
                                    <input type="checkbox" class="custom-control-input" id="toggleSunat"
                                           th:checked="${sunatActivo}" onchange="toggleSunat(this.checked)">
                                    <label class="custom-control-label" for="toggleSunat">
                                        <span th:if="${sunatActivo}" class="badge badge-success badge-lg">ACTIVO</span>
                                        <span th:unless="${sunatActivo}" class="badge badge-secondary badge-lg">OFFLINE</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen Mes Actual -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="info-box bg-purple">
                            <span class="info-box-icon"><i class="fas fa-file-alt"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Comprobantes del Mes</span>
                                <span class="info-box-number" th:text="${resumen.comprobantesEmitidos}">0</span>
                                <small th:text="'Boletas: ' + ${resumen.boletas} + ' | Facturas: ' + ${resumen.facturas}"></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box bg-success">
                            <span class="info-box-icon"><i class="fas fa-gift"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Gratis Restantes</span>
                                <span class="info-box-number" th:text="${resumen.comprobantesGratisRestantes}">20</span>
                                <small>de 20 comprobantes gratis</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box" th:classappend="${resumen.costoEstimado.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? 'bg-warning' : 'bg-info'">
                            <span class="info-box-icon"><i class="fas fa-calculator"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Costo Mes Actual</span>
                                <span class="info-box-number" th:text="'S/ ' + ${resumen.costoEstimado}">S/ 0.00</span>
                                <small th:text="'Rango: ' + ${resumen.rangoActual}"></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box" th:classappend="${resumen.tieneDeudaPendiente} ? 'bg-danger' : 'bg-secondary'">
                            <span class="info-box-icon"><i class="fas fa-money-bill-wave"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Deuda Total</span>
                                <span class="info-box-number" th:text="'S/ ' + ${resumen.deudaTotal ?: 0}">S/ 0.00</span>
                                <small th:text="${resumen.mesesConDeuda} + ' mes(es) pendiente(s)'"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Tarifas -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card card-info card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-tags"></i> Tabla de Tarifas</h3>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-striped table-sm">
                                    <thead class="bg-info text-white">
                                        <tr>
                                            <th>Rango de Comprobantes</th>
                                            <th class="text-right">Costo Mensual</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-success">
                                            <td><i class="fas fa-gift text-success"></i> 0 - 20</td>
                                            <td class="text-right font-weight-bold text-success">GRATIS</td>
                                        </tr>
                                        <tr><td>21 - 100</td><td class="text-right">S/ 20.00</td></tr>
                                        <tr><td>101 - 300</td><td class="text-right">S/ 40.00</td></tr>
                                        <tr><td>301 - 500</td><td class="text-right">S/ 60.00</td></tr>
                                        <tr><td>501 - 1000</td><td class="text-right">S/ 90.00</td></tr>
                                        <tr><td>1001 - 2000</td><td class="text-right">S/ 150.00</td></tr>
                                        <tr><td>2001 - 5000</td><td class="text-right">S/ 250.00</td></tr>
                                        <tr><td>5001+</td><td class="text-right">S/ 400.00</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Historial de Meses -->
                    <div class="col-md-6">
                        <div class="card card-secondary card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Historial de Consumo</h3>
                            </div>
                            <div class="card-body p-0" style="max-height: 350px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Mes</th>
                                            <th class="text-center">Comprobantes</th>
                                            <th class="text-right">Monto</th>
                                            <th class="text-center">Estado</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="mes : ${historial}">
                                            <td th:text="${mes.mesAnio}">01-2026</td>
                                            <td class="text-center" th:text="${mes.cantidadComprobantes}">0</td>
                                            <td class="text-right" th:text="'S/ ' + ${mes.montoCalculado}">S/ 0.00</td>
                                            <td class="text-center">
                                                <span th:if="${mes.estadoPago.name() == 'GRATIS'}" class="badge badge-info">GRATIS</span>
                                                <span th:if="${mes.estadoPago.name() == 'PAGADO'}" class="badge badge-success">PAGADO</span>
                                                <span th:if="${mes.estadoPago.name() == 'PENDIENTE' and mes.montoCalculado.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                                      class="badge badge-danger">PENDIENTE</span>
                                                <span th:if="${mes.estadoPago.name() == 'PENDIENTE' and mes.montoCalculado.compareTo(T(java.math.BigDecimal).ZERO) == 0}"
                                                      class="badge badge-secondary">-</span>
                                            </td>
                                            <td>
                                                <button th:if="${mes.estadoPago.name() == 'PENDIENTE' and mes.montoCalculado.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                                        class="btn btn-xs btn-success"
                                                        th:onclick="'marcarPagado(\'' + ${mes.mesAnio} + '\')'">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(historial)}">
                                            <td colspan="5" class="text-center text-muted">No hay registros aun</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script>
    // Obtener token CSRF para las peticiones AJAX
    var csrfToken = $('meta[name="_csrf"]').attr('content');
    var csrfHeader = $('meta[name="_csrf_header"]').attr('content');

    function toggleSunat(activar) {
        $.ajax({
            url: '/configuracion/sunat-billing/api/toggle-sunat',
            method: 'POST',
            data: { activar: activar },
            beforeSend: function(xhr) {
                if (csrfToken && csrfHeader) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                }
            },
            success: function(resp) {
                if (resp.success) {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'success',
                        title: resp.mensaje,
                        showConfirmButton: false,
                        timer: 3000
                    });
                    // Actualizar badge
                    var badge = $('#toggleSunat').next('label').find('span');
                    if (activar) {
                        badge.removeClass('badge-secondary').addClass('badge-success').text('ACTIVO');
                    } else {
                        badge.removeClass('badge-success').addClass('badge-secondary').text('OFFLINE');
                    }
                } else {
                    Swal.fire('Error', resp.mensaje || 'No se pudo cambiar el estado', 'error');
                    $('#toggleSunat').prop('checked', !activar);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error toggle SUNAT:', status, error, xhr.responseText);
                var mensaje = 'No se pudo cambiar el estado';
                if (xhr.status === 403) {
                    mensaje = 'No tiene permisos para realizar esta accion';
                } else if (xhr.status === 401) {
                    mensaje = 'Sesion expirada. Recargue la pagina';
                }
                Swal.fire('Error', mensaje, 'error');
                // Revertir checkbox
                $('#toggleSunat').prop('checked', !activar);
            }
        });
    }

    function marcarPagado(mesAnio) {
        Swal.fire({
            title: 'Marcar como Pagado',
            html: '<p>Confirmar pago del mes <strong>' + mesAnio + '</strong></p>' +
                  '<input type="text" id="observaciones" class="swal2-input" placeholder="Observaciones (opcional)">',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Confirmar Pago',
            cancelButtonText: 'Cancelar'
        }).then(function(result) {
            if (result.isConfirmed) {
                var obs = document.getElementById('observaciones').value;
                $.ajax({
                    url: '/configuracion/sunat-billing/api/marcar-pagado',
                    method: 'POST',
                    data: { mesAnio: mesAnio, observaciones: obs },
                    beforeSend: function(xhr) {
                        if (csrfToken && csrfHeader) {
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        }
                    },
                    success: function(resp) {
                        if (resp.success) {
                            Swal.fire('Pagado', resp.mensaje, 'success').then(function() {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', resp.mensaje, 'error');
                        }
                    },
                    error: function(xhr) {
                        var mensaje = 'No se pudo registrar el pago';
                        if (xhr.status === 403) {
                            mensaje = 'No tiene permisos para realizar esta accion';
                        }
                        Swal.fire('Error', mensaje, 'error');
                    }
                });
            }
        });
    }
</script>
</body>
</html>
