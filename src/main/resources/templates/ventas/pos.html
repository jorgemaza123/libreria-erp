<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<style>
    /* FONDO Y CENTRADO */
    .content-wrapper { background-color: #e9ecef; }
    
    /* RECTÁNGULO CENTRAL (PRODUCTOS) */
    .card-main {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        min-height: 75vh;
        display: flex;
        flex-direction: column;
    }

    /* RECTÁNGULO LATERAL */
    .card-side {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        background: white;
        position: sticky;
        top: 10px;
    }

    /* TOTAL GIGANTE */
    .total-box {
        background: #2c3e50;
        color: #2ecc71;
        padding: 12px;
        text-align: center;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    .total-amount { font-size: 2rem; font-weight: 800; font-family: monospace; }
    .total-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #bdc3c7; }

    /* TABLA COMPACTA */
    .table-pos thead th { background-color: #34495e; color: white; padding: 8px; }
    .table-pos td { vertical-align: middle !important; padding: 5px !important; }
    
    /* INPUTS EN TABLA (CANTIDAD) */
    .input-qty {
        width: 70px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1rem;
        border: 2px solid #ddd;
        border-radius: 4px;
    }
    .input-qty:focus {
        border-color: #3498db;
        background-color: #ebf5fb;
        outline: none;
    }

    /* BUSCADOR SELECT2 */
    .select2-container .select2-selection--single { height: 45px !important; }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered { 
        line-height: 43px !important; font-size: 1.2rem; 
    }
    
    /* Resaltar fila activa */
    .table-active-row { background-color: #fff3cd !important; }
</style>
<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='pos')}"></aside>

    <div class="content-wrapper pt-3 px-3">
        <div class="container-fluid">
            <div class="row justify-content-center">
                
                <!-- COLUMNA IZQUIERDA: PRODUCTOS -->
                <div class="col-xl-7 col-lg-7">
                    <div class="card card-main">
                        <div class="card-header bg-white border-bottom-0 pt-3 px-4">
                            <h5 class="text-secondary mb-3"><i class="fas fa-cash-register"></i> Punto de Venta (POS)</h5>
                            <div class="row">
                                <div class="col-md-12">
                                    <select id="busquedaAjax" class="form-control" style="width: 100%;"></select>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0 table-responsive flex-grow-1">
                            <table class="table table-pos table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">#</th>
                                        <th style="width: 40%">Producto</th>
                                        <th style="width: 15%" class="text-right">Precio</th>
                                        <th style="width: 10%" class="text-center">Cant.</th>
                                        <th style="width: 15%" class="text-right">Subtotal</th>
                                        <th style="width: 5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyCarrito"></tbody>
                            </table>
                            <div id="msgVacio" class="text-center mt-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3 text-gray-300"></i>
                                <p>Busque un producto para comenzar...</p>
                            </div>

                            <!-- PANEL DE PRODUCTOS RÁPIDOS (Quick Pick) -->
                            <div id="panelRapido" class="p-3 border-top bg-light">
                                <h6 class="text-secondary mb-3">
                                    <i class="fas fa-bolt text-warning"></i> Productos Rápidos (sin código)
                                </h6>
                                <div class="d-flex flex-wrap justify-content-start">
                                    <a class="btn btn-app bg-white shadow-sm m-1" href="javascript:void(0)"
                                       onclick="agregarRapido('FOTOCOPIA_BN', 'Fotocopia B/N', 0.10)">
                                        <i class="fas fa-copy text-secondary"></i>
                                        <span class="d-block small">Fotocopia B/N</span>
                                        <span class="badge bg-success">S/ 0.10</span>
                                    </a>
                                    <a class="btn btn-app bg-white shadow-sm m-1" href="javascript:void(0)"
                                       onclick="agregarRapido('IMPRESION_A4', 'Impresión A4', 0.50)">
                                        <i class="fas fa-print text-primary"></i>
                                        <span class="d-block small">Impresión A4</span>
                                        <span class="badge bg-success">S/ 0.50</span>
                                    </a>
                                    <a class="btn btn-app bg-white shadow-sm m-1" href="javascript:void(0)"
                                       onclick="agregarRapido('ANILLADO', 'Anillado', 3.50)">
                                        <i class="fas fa-ring text-info"></i>
                                        <span class="d-block small">Anillado</span>
                                        <span class="badge bg-success">S/ 3.50</span>
                                    </a>
                                    <a class="btn btn-app bg-white shadow-sm m-1" href="javascript:void(0)"
                                       onclick="agregarRapido('BOLSA_PLASTICA', 'Bolsa Plástica', 0.10)">
                                        <i class="fas fa-shopping-bag text-warning"></i>
                                        <span class="d-block small">Bolsa Plástica</span>
                                        <span class="badge bg-success">S/ 0.10</span>
                                    </a>
                                    <a class="btn btn-app bg-white shadow-sm m-1" href="javascript:void(0)"
                                       onclick="agregarRapido('LAPICERO_AZUL', 'Lapicero Azul', 1.00)">
                                        <i class="fas fa-pen text-primary"></i>
                                        <span class="d-block small">Lapicero Azul</span>
                                        <span class="badge bg-success">S/ 1.00</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer bg-light text-muted small">
                            <i class="fas fa-keyboard"></i>
                            <b>F2</b> Preparar Cobro |
                            <b>F4</b> Cambiar Comprobante |
                            <b>Enter</b> Suma +1 |
                            <b>Tab</b> Volver a buscar
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: VISOR + DATOS + ACCIONES -->
                <div class="col-xl-4 col-lg-5">
                    
                    <!-- VISOR DE PRODUCTO -->
                    <div class="card card-side mb-3">
                        <div class="card-header bg-info text-white p-3">
                            <div class="d-flex align-items-center">
                                <img class="rounded-circle mr-3 elevation-2" id="visorImagen" 
                                     src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzU1NSIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TElCPC90ZXh0Pjwvc3ZnPg==" 
                                     alt="Img" style="width: 70px; height: 70px; object-fit: cover; background: white;">
                                <div class="flex-grow-1">
                                    <h5 class="mb-0 font-weight-bold" id="visorNombre">Seleccione un producto</h5>
                                    <span class="opacity-75" style="font-size: 1rem;" id="visorMarca">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body p-3">
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Precio</small>
                                    <span class="badge bg-primary font-weight-bold" style="font-size: 1.1rem;" id="visorPrecio">S/ 0.00</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Stock</small>
                                    <span class="badge bg-success font-weight-bold" style="font-size: 1.1rem;" id="visorStock">0</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Ubicación</small>
                                    <span class="text-dark font-weight-bold" style="font-size: 1rem;" id="visorUbicacion">-</span>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text font-weight-bold">Cant.</span>
                                </div>
                                <input type="number" id="inputCantidad" class="form-control form-control-lg text-center font-weight-bold" value="1" min="1" style="font-size: 1.3rem;">
                                <div class="input-group-append">
                                    <button class="btn btn-success btn-lg px-4" type="button" onclick="agregarDesdeVisor()">
                                        <i class="fas fa-plus"></i> AGREGAR
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOTAL + DATOS DEL CLIENTE + ACCIONES -->
                    <div class="card card-side p-3">
                        
                        <!-- TOTAL GIGANTE -->
                        <div class="total-box">
                            <div class="total-label">Total a Pagar</div>
                            <div class="total-amount" id="totalPantalla">S/ 0.00</div>
                        </div>

                        <!-- DATOS DEL CLIENTE -->
                        <h6 class="font-weight-bold text-secondary border-bottom pb-2">Datos del Cliente</h6>
                        
                        <div class="form-group mb-2">
                            <label class="small mb-1">Tipo Comprobante</label>
                            <select id="tipoComprobante" class="form-control form-control-sm">
                                <option value="BOLETA">BOLETA</option>
                                <option value="FACTURA">FACTURA</option>
                                <option value="NOTA_VENTA">NOTA VENTA</option>
                            </select>
                        </div>

                        <div class="form-group mb-2">
                            <label class="small mb-1">DNI / RUC</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="clienteDoc" class="form-control" placeholder="00000000" maxlength="11">
                                <div class="input-group-append">
                                    <button type="button" id="btnBuscarDoc" class="btn btn-info" onclick="buscarDocumento()" title="Buscar en SUNAT/RENIEC" style="display: none;">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <small id="docFeedback" class="text-muted" style="display: none;"></small>
                        </div>

                        <div class="form-group mb-2">
                            <label class="small mb-1">Cliente *</label>
                            <input type="text" id="cliente" class="form-control form-control-sm font-weight-bold" placeholder="Nombre / Razón Social">
                        </div>

                        <div class="form-group mb-2" id="divDireccion" style="display: none;">
                            <label class="small mb-1">Direccion</label>
                            <input type="text" id="clienteDireccion" class="form-control form-control-sm" placeholder="Direccion fiscal">
                        </div>

                        <!-- CONDICIÓN DE PAGO -->
                        <h6 class="font-weight-bold text-secondary border-bottom pb-2 mt-3">Condición de Pago</h6>
                        
                        <div class="form-group mb-2">
                            <select id="formaPago" class="form-control form-control-sm font-weight-bold" onchange="toggleCredito()">
                                <option value="CONTADO">CONTADO</option>
                                <option value="CREDITO">CRÉDITO / CUOTAS</option>
                            </select>
                        </div>
                        <div class="form-group mb-2">
                            <label class="small mb-1">Método de Pago</label>
                            <select id="metodoPago" class="form-control form-control-sm font-weight-bold text-navy">
                                <option value="EFECTIVO" selected>EFECTIVO (S/)</option>
                                <option value="YAPE">YAPE</option>
                                <option value="PLIN">PLIN</option>
                                <option value="TARJETA">TARJETA (Débito/Crédito)</option>
                                <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                                <option value="MIXTO">MIXTO / OTRO</option>
                            </select>
                        </div>

                        <div class="div-credito d-none">
                            <div class="form-group mb-2">
                                <label class="small mb-1">Días Crédito</label>
                                <select id="diasCredito" class="form-control form-control-sm">
                                    <option value="7">7 Días</option>
                                    <option value="15">15 Días</option>
                                    <option value="30">30 Días</option>
                                </select>
                            </div>
                            <div class="form-group mb-2">
                                <label class="small mb-1">A Cuenta (S/)</label>
                                <input type="number" id="montoInicial" class="form-control form-control-sm text-right" value="0.00" onkeyup="calcularSaldo()">
                            </div>
                            <div class="text-right mb-3">
                                <small>Saldo Pendiente:</small>
                                <h5 class="text-danger font-weight-bold mb-0" id="lblSaldo">S/ 0.00</h5>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <button class="btn btn-success btn-block btn-lg font-weight-bold shadow-sm mb-2" onclick="procesarVenta()">
                            <i class="fas fa-cash-register"></i> COBRAR (F2)
                        </button>
                        
                        <button class="btn btn-default btn-block btn-sm" onclick="limpiar()">
                            <i class="fas fa-eraser"></i> Limpiar Todo
                        </button>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>
<script th:inline="javascript">
    let carrito = [];
    let productoActual = null;
    let totalVenta = 0;

    // CONTROL DE PRECIOS: Determina si el usuario puede editar precios
    // Solo ADMIN puede modificar precios en el POS
    const esAdminGlobal = /*[[${#authorization.expression('hasRole("ADMIN")')}]]*/ false;

    // FACTURACION ELECTRONICA: Determina si las validaciones SUNAT estan activas
    const facturaElectronicaActiva = /*[[${facturaElectronicaActiva}]]*/ false;

    const IMG_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzU1NSIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tk88L3RleHQ+PC9zdmc+";

    $(document).ready(function() {
        // --- CONFIGURACIÓN DEL BUSCADOR (SELECT2) ---
        $('#busquedaAjax').select2({
            theme: 'bootstrap4',
            placeholder: 'Escanear código o buscar...',
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: '/ventas/api/buscar-productos',
                dataType: 'json',
                delay: 50,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { 
                    return { 
                        results: data.map(p => ({
                            id: p.id,
                            text: p.text + " (Stock: " + p.stock + ")",
                            producto: p
                        })) 
                    }; 
                }
            }
        });

        // --- LÓGICA DE SELECCIÓN ---
        $('#busquedaAjax').on('select2:select', function (e) {
            let prod = e.params.data.producto;
            cargarVisor(prod);
            agregarAlCarrito(prod);
            $('#busquedaAjax').val(null).trigger('change');
        });

        // Foco inicial al buscador
        setTimeout(() => $('#busquedaAjax').select2('open'), 300);

        // =============================================
        // ATAJOS DE TECLADO GLOBALES
        // =============================================
        $(document).keydown(function(e) {
            // F2: Preparar cobro (enfocar campo según tipo de pago)
            if (e.key === 'F2') {
                e.preventDefault();
                prepararCobro();
            }

            // F4: Cambiar tipo de comprobante cíclicamente
            if (e.key === 'F4') {
                e.preventDefault();
                cambiarTipoComprobante();
            }
        });
    });

    // --- FUNCIONES DEL VISOR ---

    function cargarVisor(data) {
        productoActual = data;
        $("#visorNombre").text(data.nombre);
        $("#visorMarca").text(data.marca || 'Genérico');
        $("#visorPrecio").text('S/ ' + parseFloat(data.precio).toFixed(2));
        $("#visorStock").text(data.stock);
        $("#visorUbicacion").text(data.ubicacion || '-');
        
        if(data.imagen) $("#visorImagen").attr("src", "/images/" + data.imagen);
        else $("#visorImagen").attr("src", IMG_PLACEHOLDER);

        $("#inputCantidad").val(1);
    }

    function agregarDesdeVisor() {
        if(!productoActual) return;
        let cant = parseInt($("#inputCantidad").val());

        if(cant > productoActual.stock) {
            Swal.fire('Stock Insuficiente', 'Solo quedan ' + productoActual.stock, 'warning');
            return;
        }

        let existente = carrito.find(i => i.id === productoActual.id);
        if(existente) {
            existente.cantidad += cant;
            let index = carrito.findIndex(i => i.id === productoActual.id);
            dibujarCarrito(true, index);
        } else {
            carrito.push({
                id: productoActual.id,
                nombre: productoActual.nombre,
                precio: parseFloat(productoActual.precio),
                precioMin: parseFloat(productoActual.precioMin) || 0,
                cantidad: cant,
                stock: productoActual.stock
            });
            dibujarCarrito(true, carrito.length - 1);
        }
    }

    // =============================================
    // PRODUCTOS RÁPIDOS (Quick Pick)
    // =============================================

    /**
     * Agrega un producto rápido al carrito sin pasar por el buscador.
     * Estos productos son servicios que no requieren stock ni código de barras.
     * @param {string} id - Identificador único del producto rápido
     * @param {string} nombre - Nombre a mostrar en el carrito
     * @param {number} precio - Precio unitario
     */
    // =========================================================
// REEMPLAZAR SOLO LA FUNCIÓN agregarRapido EN TU SCRIPT
// =========================================================

function agregarRapido(codigoBusqueda) {
    // 1. Usamos tu API existente para buscar el producto por su código interno (ej: 'FOTOCOPIA_BN')
    $.ajax({
        url: '/ventas/api/buscar-productos',
        data: { term: codigoBusqueda },
        success: function(resultados) {
            // 2. Buscamos coincidencia exacta o tomamos el primero que devuelva la API
            // La API devuelve objetos con {id: 123, text: '...', ...}
            let prodEncontrado = resultados.find(p => p.text.includes(codigoBusqueda)) || resultados[0];

            if (prodEncontrado) {
                // 3. ¡CRÍTICO! Aquí obtenemos el ID numérico real (ej: 45) en lugar del texto
                // Esto soluciona el error "InvalidFormatException" en el backend
                
                // Creamos un objeto compatible con tu función agregarAlCarrito
                let productoParaCarrito = {
                    id: prodEncontrado.id, // ES UN NÚMERO (Long)
                    nombre: prodEncontrado.nombre,
                    precio: parseFloat(prodEncontrado.precio),
                    precioMin: parseFloat(prodEncontrado.precioMin),
                    stock: prodEncontrado.stock
                };

                // Llamamos a tu función existente
                agregarAlCarrito(productoParaCarrito);
                
                // Feedback visual
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: prodEncontrado.nombre + ' agregado',
                    showConfirmButton: false,
                    timer: 800
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Producto no encontrado',
                    text: 'El código "' + codigoBusqueda + '" no está registrado en el inventario. Créalo con tipo "SERVICIO".'
                });
            }
        },
        error: function() {
            Swal.fire('Error', 'No se pudo consultar el producto rápido', 'error');
        }
    });
}

    // =============================================
    // ATAJOS DE TECLADO - FUNCIONES
    // =============================================

    /**
     * F2: Prepara el cobro enfocando el campo apropiado
     * - Si es CRÉDITO -> Enfoca #montoInicial
     * - Si es CONTADO -> Enfoca #clienteDoc
     */
    function prepararCobro() {
        // Validar que hay productos en el carrito
        if (carrito.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Carrito Vacío',
                text: 'Agregue productos antes de cobrar',
                timer: 1500,
                showConfirmButton: false
            });
            $('#busquedaAjax').select2('open');
            return;
        }

        let formaPago = $("#formaPago").val();

        if (formaPago === 'CREDITO') {
            // Crédito: Enfocar monto inicial
            $("#montoInicial").focus().select();
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'info',
                title: 'Ingrese el monto a cuenta',
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            // Contado: Enfocar documento del cliente
            $("#clienteDoc").focus().select();
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'info',
                title: 'Ingrese DNI/RUC del cliente',
                showConfirmButton: false,
                timer: 1500
            });
        }
    }

    /**
     * F4: Cambia cíclicamente el tipo de comprobante
     * BOLETA -> FACTURA -> NOTA_VENTA -> BOLETA...
     */
    function cambiarTipoComprobante() {
        let $select = $("#tipoComprobante");
        let actual = $select.val();
        let siguiente;

        // Ciclo: BOLETA -> FACTURA -> NOTA_VENTA -> BOLETA
        switch(actual) {
            case 'BOLETA':
                siguiente = 'FACTURA';
                break;
            case 'FACTURA':
                siguiente = 'NOTA_VENTA';
                break;
            case 'NOTA_VENTA':
            default:
                siguiente = 'BOLETA';
                break;
        }

        $select.val(siguiente).trigger('change');

        // Feedback visual
        Swal.fire({
            toast: true,
            position: 'top',
            icon: 'success',
            title: 'Comprobante: ' + siguiente.replace('_', ' '),
            showConfirmButton: false,
            timer: 1000
        });
    }

    // --- FUNCIONES DEL CARRITO ---

    function agregarAlCarrito(prod) {
        let index = carrito.findIndex(i => i.id == prod.id);
        
        if(index !== -1) {
            // Si existe, mover foco ahí
            dibujarCarrito(true, index);
        } else {
            // Nuevo item
            carrito.push({
                id: prod.id,
                nombre: prod.nombre,
                precio: parseFloat(prod.precio) || 0,
                precioMin: parseFloat(prod.precioMin) || 0,
                cantidad: 1,
                stock: prod.stock
            });
            dibujarCarrito(true, carrito.length - 1);
        }
    }

    function dibujarCarrito(enfocar = false, indexFocus = -1) {
        let html = '';
        totalVenta = 0;

        if (carrito.length === 0) $('#msgVacio').show();
        else $('#msgVacio').hide();

        carrito.forEach((item, index) => {
            let subtotal = item.cantidad * item.precio;
            totalVenta += subtotal;
            
            let activeClass = (index === indexFocus) ? 'table-active-row' : '';

            html += `<tr class="${activeClass}">
                <td class="text-center text-muted">${index + 1}</td>
                <td><span class="font-weight-bold text-dark">${item.nombre}</span></td>
                <td class="text-right">
                    <input type="number" step="0.10"
                           class="form-control form-control-sm text-right border-0 ${esAdminGlobal ? '' : 'bg-light'}"
                           value="${item.precio.toFixed(2)}"
                           ${esAdminGlobal ? '' : 'readonly'}
                           onchange="cambiarPrecio(${index}, this.value)">
                </td>
                <td class="text-center">
                    <input type="number" id="cant_${index}" class="input-qty" 
                           value="${item.cantidad}" 
                           onkeydown="handleCantidadKey(event, ${index})"
                           onchange="cambiarCantidad(${index}, this.value)">
                </td>
                <td class="text-right font-weight-bold text-success">S/ ${subtotal.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-link text-danger btn-sm p-0" onclick="eliminar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        $('#tbodyCarrito').html(html);
        $('#totalPantalla').text(`S/ ${totalVenta.toFixed(2)}`);
        
        if($("#formaPago").val() === 'CREDITO') {
            calcularSaldo();
        }

        // GESTIÓN DEL FOCO AUTOMÁTICO
        if(enfocar && indexFocus !== -1) {
            setTimeout(() => {
                let input = document.getElementById(`cant_${indexFocus}`);
                if(input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }
    }

    // --- LÓGICA DE TECLADO (CORE DEL POS) ---

    function handleCantidadKey(e, index) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // ENTER = SUMAR 1
            let input = document.getElementById(`cant_${index}`);
            let val = parseFloat(input.value) || 0;
            
            carrito[index].cantidad = val + 1;
            dibujarCarrito(true, index);
        }
        
        if (e.key === 'Tab') {
            e.preventDefault();
            
            // TAB = VOLVER AL BUSCADOR Y ENFOCAR PARA ESCRIBIR
            $('#busquedaAjax').select2('open');
            
            setTimeout(() => {
                let searchField = document.querySelector('.select2-container--open .select2-search__field');
                if (searchField) {
                    searchField.focus();
                }
            }, 50);
        }
    }

    function cambiarCantidad(index, val) {
        let cant = parseInt(val);
        if(cant < 1) cant = 1;
        carrito[index].cantidad = cant;
        
        // Recalcular total sin perder foco
        totalVenta = carrito.reduce((acc, i) => acc + (i.cantidad * i.precio), 0);
        $('#totalPantalla').text(`S/ ${totalVenta.toFixed(2)}`);
        
        if($("#formaPago").val() === 'CREDITO') {
            calcularSaldo();
        }
    }

    async function cambiarPrecio(index, nuevoPrecio) {
        // CONTROL DE PRECIOS: Solo ADMIN puede modificar
        if (!esAdminGlobal) {
            Swal.fire('Acceso Denegado', 'Solo administradores pueden modificar precios', 'error');
            dibujarCarrito(); // Restaurar valor original
            return;
        }

        let item = carrito[index];
        let precio = parseFloat(nuevoPrecio);

        if (precio < item.precioMin) {
            const { value: pass } = await Swal.fire({
                title: 'AUTORIZACIÓN REQUERIDA',
                text: `El precio mínimo es S/ ${item.precioMin.toFixed(2)}. Ingrese clave de Supervisor:`,
                input: 'password',
                icon: 'warning',
                showCancelButton: true
            });

            if (pass === '1234') {
                item.precio = precio;
                item.precioModificado = true; // Marca para validación backend
            }
        } else {
            item.precio = precio;
            item.precioModificado = true; // Marca para validación backend
        }
        dibujarCarrito();
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        dibujarCarrito();
    }

    // --- FUNCIONES DE PAGO ---

    function toggleCredito() {
        let tipo = $("#formaPago").val();
        if(tipo === 'CREDITO') {
            $(".div-credito").removeClass('d-none');
            calcularSaldo();
        } else {
            $(".div-credito").addClass('d-none');
        }
    }

    function calcularSaldo() {
        let inicial = parseFloat($("#montoInicial").val()) || 0;
        let saldo = totalVenta - inicial;
        if(saldo < 0) saldo = 0;
        $("#lblSaldo").text('S/ ' + saldo.toFixed(2));
    }

    function limpiar() {
        if(confirm('¿Limpiar venta?')) {
            carrito = [];
            dibujarCarrito();
            $("#cliente").val('');
            $("#clienteDoc").val('');
            $("#clienteDireccion").val('');
            $("#docFeedback").hide();
            $("#formaPago").val("CONTADO").trigger('change');
            $("#montoInicial").val("0.00");
            $('#busquedaAjax').select2('open');
        }
    }

    function procesarVenta() {
        // Validación 1: Carrito vacío
        if(carrito.length === 0) {
            return Swal.fire({
                icon: 'warning',
                title: 'Carrito Vacío',
                text: 'Agregue al menos un producto para realizar la venta.',
                confirmButtonText: 'Entendido'
            });
        }

        // Validación 2: Productos sin cantidad válida
        let itemsInvalidos = carrito.filter(i => !i.cantidad || i.cantidad <= 0);
        if (itemsInvalidos.length > 0) {
            return Swal.fire({
                icon: 'error',
                title: 'Cantidad Inválida',
                text: 'Hay productos con cantidad inválida. Verifique el carrito.',
                confirmButtonText: 'Revisar'
            });
        }

        // Validación 3: Productos sin precio válido
        let sinPrecio = carrito.filter(i => !i.precio || i.precio <= 0);
        if (sinPrecio.length > 0) {
            return Swal.fire({
                icon: 'error',
                title: 'Precio Inválido',
                text: 'Hay productos sin precio válido. Verifique el carrito.',
                confirmButtonText: 'Revisar'
            });
        }

        let formaPago = $("#formaPago").val();
        let doc = $("#clienteDoc").val();
        let tipoComprobante = $("#tipoComprobante").val();

        // Validación 4: Crédito requiere documento
        if (formaPago === 'CREDITO' && (!doc || doc.length < 8)) {
            return Swal.fire({
                icon: 'warning',
                title: 'Datos Incompletos',
                text: 'Para ventas a crédito es obligatorio ingresar el DNI o RUC del cliente.',
                confirmButtonText: 'Completar Datos'
            });
        }

        // Validación 5: Factura requiere RUC
        if (tipoComprobante === 'FACTURA' && (!doc || doc.length !== 11)) {
            return Swal.fire({
                icon: 'warning',
                title: 'RUC Requerido',
                text: 'Para emitir Factura se requiere un RUC válido de 11 dígitos.',
                confirmButtonText: 'Completar Datos'
            });
        }

        // Validación 6: Factura requiere RUC validado y ACTIVO/HABIDO
        // Solo aplica si la facturacion electronica esta activa
        if (tipoComprobante === 'FACTURA' && facturaElectronicaActiva) {
            if (!rucValidado) {
                return Swal.fire({
                    icon: 'warning',
                    title: 'RUC No Validado',
                    text: 'Debe consultar el RUC en SUNAT antes de emitir la Factura. Haga clic en el boton de busqueda.',
                    confirmButtonText: 'Entendido'
                });
            }
            if (!rucActivo) {
                return Swal.fire({
                    icon: 'error',
                    title: 'Contribuyente No Activo',
                    text: 'No se puede emitir Factura. El contribuyente no esta ACTIVO o no esta HABIDO en SUNAT.',
                    confirmButtonText: 'Entendido'
                });
            }
        }

        // Validación 7: Boleta con monto > S/ 700 requiere DNI
        // Solo aplica si la facturacion electronica esta activa
        if (tipoComprobante === 'BOLETA' && totalVenta > 700 && facturaElectronicaActiva) {
            if (!doc || doc.length !== 8) {
                return Swal.fire({
                    icon: 'warning',
                    title: 'DNI Requerido',
                    html: 'Segun normativa SUNAT, para <b>Boletas mayores a S/ 700.00</b> es obligatorio identificar al cliente con su DNI (8 digitos).<br><br>' +
                          '<b>Total de venta:</b> S/ ' + totalVenta.toFixed(2),
                    confirmButtonText: 'Completar DNI'
                });
            }
        }

        let dto = {
            clienteNombre: $("#cliente").val() || 'CLIENTE VARIOS',
            clienteDocumento: doc || '00000000',
            clienteDireccion: $("#clienteDireccion").val() || '',
            tipoComprobante: tipoComprobante,
            formaPago: formaPago,
            metodoPago: $("#metodoPago").val(),
            montoInicial: parseFloat($("#montoInicial").val()) || 0,
            diasCredito: parseInt($("#diasCredito").val()) || 7,
            items: carrito.map(i => ({ productoId: i.id, cantidad: i.cantidad, precioVenta: i.precio }))
        };

        // Mostrar loading
        Swal.fire({
            title: 'Procesando venta...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => { Swal.showLoading(); }
        });

        $.ajax({
            url: '/ventas/api/guardar',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(resp) {
                Swal.fire({
                    title: '¡Venta Exitosa!',
                    html: '<strong>' + resp.serie + '-' + resp.numero + '</strong><br>Comprobante generado correctamente',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    imprimirPopup('/ventas/imprimir/' + resp.id);
                    carrito = [];
                    dibujarCarrito();
                    $("#cliente").val('');
                    $("#clienteDoc").val('');
                    $("#clienteDireccion").val('');
                    $("#docFeedback").hide();
                    $("#formaPago").val("CONTADO").trigger('change');
                    $("#montoInicial").val("0.00");
                    $('#busquedaAjax').select2('open');
                });
            },
            error: function(xhr, status, error) {
                let mensaje = 'Error desconocido. Por favor intente nuevamente.';
                let titulo = 'Error';

                // Manejar diferentes códigos de error
                if (xhr.status === 401) {
                    titulo = 'Sesión Expirada';
                    mensaje = 'Su sesión ha expirado. Será redirigido al login.';
                    Swal.fire({
                        icon: 'warning',
                        title: titulo,
                        text: mensaje,
                        confirmButtonText: 'Ir al Login'
                    }).then(() => {
                        window.location.href = '/login';
                    });
                    return;
                } else if (xhr.status === 403) {
                    titulo = 'Acceso Denegado';
                    mensaje = 'No tiene permisos para realizar ventas. Contacte al administrador.';
                } else if (xhr.status === 400) {
                    // Error de validación o negocio
                    try {
                        let resp = JSON.parse(xhr.responseText);
                        mensaje = resp.error || resp.message || xhr.responseText;
                    } catch(e) {
                        mensaje = xhr.responseText || 'Error en los datos enviados.';
                    }

                    // DETECCIÓN ESPECIAL: CAJA CERRADA (usa función global del layout)
                    if (window.esCajaCerrada && window.esCajaCerrada(mensaje)) {
                        window.mostrarAlertaCajaCerrada();
                        return;
                    }
                } else if (xhr.status === 409) {
                    titulo = 'Conflicto de Stock';
                    mensaje = 'Otro vendedor modificó el stock. Por favor actualice la página e intente nuevamente.';
                } else if (xhr.status === 500) {
                    titulo = 'Error del Servidor';
                    mensaje = 'Ocurrió un error interno. Por favor contacte al administrador.';
                } else if (xhr.status === 0) {
                    titulo = 'Sin Conexión';
                    mensaje = 'No se pudo conectar con el servidor. Verifique su conexión a internet.';
                }

                Swal.fire({
                    icon: 'error',
                    title: titulo,
                    text: mensaje,
                    confirmButtonText: 'Entendido'
                });
            }
        });
    }

    function imprimirPopup(url) {
        const width = 900;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(url, 'Comprobante', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
    }

    function reportarSinStock() {
        Swal.fire({
            title: 'Reportar Falta de Stock',
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Registrar'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                $.post('/ventas/api/solicitar-stock', { producto: result.value }, function(resp) {
                    Swal.fire('Registrado', resp, 'success');
                });
            }
        });
    }

    // =====================================
    // CONSULTA DE DOCUMENTOS (SUNAT/RENIEC)
    // Solo activo para FACTURAS
    // =====================================

    // Flag para controlar si el RUC fue validado y esta activo
    let rucValidado = false;
    let rucActivo = false;

    // Mostrar/ocultar boton de busqueda segun tipo de comprobante
    // Solo si la facturacion electronica esta activa
    function actualizarVisibilidadBusqueda() {
        let tipo = $("#tipoComprobante").val();
        if (tipo === 'FACTURA' && facturaElectronicaActiva) {
            $("#btnBuscarDoc").show();
            $("#divDireccion").show();
            // Resetear validacion al cambiar a FACTURA
            rucValidado = false;
            rucActivo = false;
        } else {
            $("#btnBuscarDoc").hide();
            // Mostrar direccion en FACTURA aunque no haya validacion SUNAT
            if (tipo === 'FACTURA') {
                $("#divDireccion").show();
            } else {
                $("#divDireccion").hide();
            }
        }
    }

    // Evento cuando cambia el tipo de comprobante
    $("#tipoComprobante").on('change', function() {
        actualizarVisibilidadBusqueda();

        // Limpiar campos si cambia de tipo
        if ($(this).val() !== 'FACTURA') {
            $("#clienteDireccion").val('');
        }
    });

    // Evento cuando se ingresa documento (solo en FACTURA con facturacion electronica)
    let timeoutBusqueda = null;
    $("#clienteDoc").on('input', function() {
        let doc = $(this).val().trim().replace(/[^0-9]/g, '');
        let tipo = $("#tipoComprobante").val();

        // Resetear validacion cuando cambia el documento (solo si facturacion activa)
        if (tipo === 'FACTURA' && facturaElectronicaActiva) {
            rucValidado = false;
            rucActivo = false;
        }

        // Solo buscar automaticamente en FACTURA con RUC de 11 digitos
        // Y solo si la facturacion electronica esta activa
        if (tipo === 'FACTURA' && doc.length === 11 && facturaElectronicaActiva) {
            // Cancelar busqueda anterior si existe
            if (timeoutBusqueda) clearTimeout(timeoutBusqueda);

            // Esperar 500ms antes de buscar (evitar multiples llamadas)
            timeoutBusqueda = setTimeout(function() {
                buscarDocumento();
            }, 500);
        }
    });

    // Funcion para buscar documento en SUNAT/RENIEC
    function buscarDocumento() {
        let doc = $("#clienteDoc").val().trim().replace(/[^0-9]/g, '');

        if (!doc || (doc.length !== 8 && doc.length !== 11)) {
            mostrarFeedback('Ingrese un DNI (8 digitos) o RUC (11 digitos)', 'warning');
            return;
        }

        // Mostrar loading
        $("#btnBuscarDoc").prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        mostrarFeedback('Consultando...', 'info');

        $.ajax({
            url: '/ventas/api/consultar-documento',
            type: 'GET',
            data: { documento: doc },
            success: function(resp) {
                if (resp.success) {
                    // Llenar campos con datos obtenidos
                    if (resp.razonSocial) {
                        $("#cliente").val(resp.razonSocial);
                    } else if (resp.nombreCompleto) {
                        $("#cliente").val(resp.nombreCompleto);
                    }

                    if (resp.direccion) {
                        $("#clienteDireccion").val(resp.direccion);
                    }

                    // Marcar RUC como validado
                    rucValidado = true;

                    // Verificar si esta ACTIVO/HABIDO
                    let esActivo = resp.activo === true;
                    rucActivo = esActivo;

                    // Mostrar mensaje segun estado
                    let estadoMsg = '';
                    if (resp.estado && resp.condicion) {
                        estadoMsg = ' - ' + resp.estado + '/' + resp.condicion;
                    }

                    if (esActivo) {
                        mostrarFeedback('Contribuyente ACTIVO/HABIDO' + estadoMsg, 'success');
                    } else {
                        // BLOQUEAR: Contribuyente no activo
                        mostrarFeedback('BLOQUEADO: ' + resp.estado + '/' + resp.condicion, 'danger');
                        Swal.fire({
                            icon: 'error',
                            title: 'No se puede emitir Factura',
                            html: '<p>El contribuyente <b>NO</b> cumple los requisitos de SUNAT:</p>' +
                                  '<p><b>Estado:</b> ' + (resp.estado || 'N/A') + '</p>' +
                                  '<p><b>Condicion:</b> ' + (resp.condicion || 'N/A') + '</p>' +
                                  '<p class="text-danger"><b>Para emitir FACTURA el contribuyente debe estar ACTIVO y HABIDO.</b></p>',
                            confirmButtonText: 'Entendido'
                        });
                    }
                } else {
                    rucValidado = true;
                    rucActivo = false;
                    mostrarFeedback(resp.error || 'No se encontraron datos', 'danger');
                }
            },
            error: function(xhr) {
                let msg = 'Error al consultar';
                try {
                    let resp = JSON.parse(xhr.responseText);
                    msg = resp.error || msg;
                } catch(e) {}
                mostrarFeedback(msg, 'danger');
            },
            complete: function() {
                $("#btnBuscarDoc").prop('disabled', false).html('<i class="fas fa-search"></i>');
            }
        });
    }

    // Mostrar feedback debajo del campo de documento
    function mostrarFeedback(mensaje, tipo) {
        let $feedback = $("#docFeedback");
        $feedback.removeClass('text-success text-danger text-warning text-info text-muted');
        $feedback.addClass('text-' + tipo);
        $feedback.text(mensaje).show();

        // Ocultar despues de 5 segundos si es exito
        if (tipo === 'success') {
            setTimeout(() => $feedback.fadeOut(), 5000);
        }
    }

    // Inicializar visibilidad al cargar
    $(document).ready(function() {
        actualizarVisibilidadBusqueda();
    });
</script>
</body>
</html>