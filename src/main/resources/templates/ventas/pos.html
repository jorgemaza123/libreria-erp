<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<style>
    /* FONDO Y CENTRADO */
    .content-wrapper { background-color: #e9ecef; }
    
    /* RECTÁNGULO CENTRAL (PRODUCTOS) */
    .card-main {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        min-height: 75vh;
        display: flex;
        flex-direction: column;
    }

    /* RECTÁNGULO LATERAL */
    .card-side {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
        background: white;
        position: sticky;
        top: 10px;
    }

    /* TOTAL GIGANTE */
    .total-box {
        background: #2c3e50;
        color: #2ecc71;
        padding: 12px;
        text-align: center;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    .total-amount { font-size: 2rem; font-weight: 800; font-family: monospace; }
    .total-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #bdc3c7; }

    /* TABLA COMPACTA */
    .table-pos thead th { background-color: #34495e; color: white; padding: 8px; }
    .table-pos td { vertical-align: middle !important; padding: 5px !important; }
    
    /* INPUTS EN TABLA (CANTIDAD) */
    .input-qty {
        width: 70px;
        text-align: center;
        font-weight: bold;
        font-size: 1.1rem;
        border: 2px solid #ddd;
        border-radius: 4px;
    }
    .input-qty:focus {
        border-color: #3498db;
        background-color: #ebf5fb;
        outline: none;
    }

    /* BUSCADOR SELECT2 */
    .select2-container .select2-selection--single { height: 45px !important; }
    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered { 
        line-height: 43px !important; font-size: 1.2rem; 
    }
    
    /* Resaltar fila activa */
    .table-active-row { background-color: #fff3cd !important; }
</style>
<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='pos')}"></aside>

    <div class="content-wrapper pt-3 px-3">
        <div class="container-fluid">
            <div class="row justify-content-center">
                
                <!-- COLUMNA IZQUIERDA: PRODUCTOS -->
                <div class="col-xl-7 col-lg-7">
                    <div class="card card-main">
                        <div class="card-header bg-white border-bottom-0 pt-3 px-4">
                            <h5 class="text-secondary mb-3"><i class="fas fa-cash-register"></i> Punto de Venta (POS)</h5>
                            <div class="row">
                                <div class="col-md-12">
                                    <select id="busquedaAjax" class="form-control" style="width: 100%;"></select>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0 table-responsive flex-grow-1">
                            <table class="table table-pos table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">#</th>
                                        <th style="width: 40%">Producto</th>
                                        <th style="width: 15%" class="text-right">Precio</th>
                                        <th style="width: 10%" class="text-center">Cant.</th>
                                        <th style="width: 15%" class="text-right">Subtotal</th>
                                        <th style="width: 5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyCarrito"></tbody>
                            </table>
                            <div id="msgVacio" class="text-center mt-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3 text-gray-300"></i>
                                <p>Busque un producto para comenzar...</p>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-light text-muted small">
                            <i class="fas fa-keyboard"></i> 
                            <b>Enter</b> en buscador: Selecciona | 
                            <b>Enter</b> en Cantidad: Suma 1 | 
                            <b>Tab</b> en Cantidad: Vuelve a buscar
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: VISOR + DATOS + ACCIONES -->
                <div class="col-xl-4 col-lg-5">
                    
                    <!-- VISOR DE PRODUCTO -->
                    <div class="card card-side mb-3">
                        <div class="card-header bg-info text-white p-3">
                            <div class="d-flex align-items-center">
                                <img class="rounded-circle mr-3 elevation-2" id="visorImagen" 
                                     src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzU1NSIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TElCPC90ZXh0Pjwvc3ZnPg==" 
                                     alt="Img" style="width: 70px; height: 70px; object-fit: cover; background: white;">
                                <div class="flex-grow-1">
                                    <h5 class="mb-0 font-weight-bold" id="visorNombre">Seleccione un producto</h5>
                                    <span class="opacity-75" style="font-size: 1rem;" id="visorMarca">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body p-3">
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Precio</small>
                                    <span class="badge bg-primary font-weight-bold" style="font-size: 1.1rem;" id="visorPrecio">S/ 0.00</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Stock</small>
                                    <span class="badge bg-success font-weight-bold" style="font-size: 1.1rem;" id="visorStock">0</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block mb-1">Ubicación</small>
                                    <span class="text-dark font-weight-bold" style="font-size: 1rem;" id="visorUbicacion">-</span>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text font-weight-bold">Cant.</span>
                                </div>
                                <input type="number" id="inputCantidad" class="form-control form-control-lg text-center font-weight-bold" value="1" min="1" style="font-size: 1.3rem;">
                                <div class="input-group-append">
                                    <button class="btn btn-success btn-lg px-4" type="button" onclick="agregarDesdeVisor()">
                                        <i class="fas fa-plus"></i> AGREGAR
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOTAL + DATOS DEL CLIENTE + ACCIONES -->
                    <div class="card card-side p-3">
                        
                        <!-- TOTAL GIGANTE -->
                        <div class="total-box">
                            <div class="total-label">Total a Pagar</div>
                            <div class="total-amount" id="totalPantalla">S/ 0.00</div>
                        </div>

                        <!-- DATOS DEL CLIENTE -->
                        <h6 class="font-weight-bold text-secondary border-bottom pb-2">Datos del Cliente</h6>
                        
                        <div class="form-group mb-2">
                            <label class="small mb-1">Tipo Comprobante</label>
                            <select id="tipoComprobante" class="form-control form-control-sm">
                                <option value="NOTA_VENTA">NOTA VENTA</option>
                                <option value="BOLETA">BOLETA</option>
                                <option value="FACTURA">FACTURA</option>
                            </select>
                        </div>

                        <div class="form-group mb-2">
                            <label class="small mb-1">DNI / RUC</label>
                            <input type="text" id="clienteDoc" class="form-control form-control-sm" placeholder="00000000">
                        </div>
                        
                        <div class="form-group mb-2">
                            <label class="small mb-1">Cliente *</label>
                            <input type="text" id="cliente" class="form-control form-control-sm font-weight-bold" placeholder="Nombre / Razón Social">
                        </div>

                        <!-- CONDICIÓN DE PAGO -->
                        <h6 class="font-weight-bold text-secondary border-bottom pb-2 mt-3">Condición de Pago</h6>
                        
                        <div class="form-group mb-2">
                            <select id="formaPago" class="form-control form-control-sm font-weight-bold" onchange="toggleCredito()">
                                <option value="CONTADO">CONTADO</option>
                                <option value="CREDITO">CRÉDITO / CUOTAS</option>
                            </select>
                        </div>

                        <div class="div-credito d-none">
                            <div class="form-group mb-2">
                                <label class="small mb-1">Días Crédito</label>
                                <select id="diasCredito" class="form-control form-control-sm">
                                    <option value="7">7 Días</option>
                                    <option value="15">15 Días</option>
                                    <option value="30">30 Días</option>
                                </select>
                            </div>
                            <div class="form-group mb-2">
                                <label class="small mb-1">A Cuenta (S/)</label>
                                <input type="number" id="montoInicial" class="form-control form-control-sm text-right" value="0.00" onkeyup="calcularSaldo()">
                            </div>
                            <div class="text-right mb-3">
                                <small>Saldo Pendiente:</small>
                                <h5 class="text-danger font-weight-bold mb-0" id="lblSaldo">S/ 0.00</h5>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <button class="btn btn-success btn-block btn-lg font-weight-bold shadow-sm mb-2" onclick="procesarVenta()">
                            <i class="fas fa-cash-register"></i> COBRAR (F2)
                        </button>
                        
                        <button class="btn btn-default btn-block btn-sm" onclick="limpiar()">
                            <i class="fas fa-eraser"></i> Limpiar Todo
                        </button>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>
<script>
    let carrito = [];
    let productoActual = null;
    let totalVenta = 0;

    const IMG_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkeT0iLjNlbSIgZmlsbD0iIzU1NSIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tk88L3RleHQ+PC9zdmc+";

    $(document).ready(function() {
        // --- CONFIGURACIÓN DEL BUSCADOR (SELECT2) ---
        $('#busquedaAjax').select2({
            theme: 'bootstrap4',
            placeholder: 'Escanear código o buscar...',
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: '/ventas/api/buscar-productos',
                dataType: 'json',
                delay: 50,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { 
                    return { 
                        results: data.map(p => ({
                            id: p.id,
                            text: p.text + " (Stock: " + p.stock + ")",
                            producto: p
                        })) 
                    }; 
                }
            }
        });

        // --- LÓGICA DE SELECCIÓN ---
        $('#busquedaAjax').on('select2:select', function (e) {
            let prod = e.params.data.producto;
            cargarVisor(prod);
            agregarAlCarrito(prod);
            $('#busquedaAjax').val(null).trigger('change');
        });

        // Foco inicial al buscador
        setTimeout(() => $('#busquedaAjax').select2('open'), 300);

        // Atajo Global F2 para cobrar
        $(document).keydown(function(e) {
            if (e.key === 'F2') {
                e.preventDefault();
                procesarVenta();
            }
        });
    });

    // --- FUNCIONES DEL VISOR ---

    function cargarVisor(data) {
        productoActual = data;
        $("#visorNombre").text(data.nombre);
        $("#visorMarca").text(data.marca || 'Genérico');
        $("#visorPrecio").text('S/ ' + parseFloat(data.precio).toFixed(2));
        $("#visorStock").text(data.stock);
        $("#visorUbicacion").text(data.ubicacion || '-');
        
        if(data.imagen) $("#visorImagen").attr("src", "/images/" + data.imagen);
        else $("#visorImagen").attr("src", IMG_PLACEHOLDER);

        $("#inputCantidad").val(1);
    }

    function agregarDesdeVisor() {
        if(!productoActual) return;
        let cant = parseInt($("#inputCantidad").val());
        
        if(cant > productoActual.stock) {
            Swal.fire('Stock Insuficiente', 'Solo quedan ' + productoActual.stock, 'warning');
            return;
        }

        let existente = carrito.find(i => i.id === productoActual.id);
        if(existente) {
            existente.cantidad += cant;
            let index = carrito.findIndex(i => i.id === productoActual.id);
            dibujarCarrito(true, index);
        } else {
            carrito.push({
                id: productoActual.id,
                nombre: productoActual.nombre,
                precio: parseFloat(productoActual.precio),
                precioMin: parseFloat(productoActual.precioMin) || 0,
                cantidad: cant,
                stock: productoActual.stock
            });
            dibujarCarrito(true, carrito.length - 1);
        }
    }

    // --- FUNCIONES DEL CARRITO ---

    function agregarAlCarrito(prod) {
        let index = carrito.findIndex(i => i.id == prod.id);
        
        if(index !== -1) {
            // Si existe, mover foco ahí
            dibujarCarrito(true, index);
        } else {
            // Nuevo item
            carrito.push({
                id: prod.id,
                nombre: prod.nombre,
                precio: parseFloat(prod.precio) || 0,
                precioMin: parseFloat(prod.precioMin) || 0,
                cantidad: 1,
                stock: prod.stock
            });
            dibujarCarrito(true, carrito.length - 1);
        }
    }

    function dibujarCarrito(enfocar = false, indexFocus = -1) {
        let html = '';
        totalVenta = 0;

        if (carrito.length === 0) $('#msgVacio').show();
        else $('#msgVacio').hide();

        carrito.forEach((item, index) => {
            let subtotal = item.cantidad * item.precio;
            totalVenta += subtotal;
            
            let activeClass = (index === indexFocus) ? 'table-active-row' : '';

            html += `<tr class="${activeClass}">
                <td class="text-center text-muted">${index + 1}</td>
                <td><span class="font-weight-bold text-dark">${item.nombre}</span></td>
                <td class="text-right">
                    <input type="number" step="0.10" class="form-control form-control-sm text-right border-0 bg-transparent" 
                           value="${item.precio.toFixed(2)}" 
                           onchange="cambiarPrecio(${index}, this.value)">
                </td>
                <td class="text-center">
                    <input type="number" id="cant_${index}" class="input-qty" 
                           value="${item.cantidad}" 
                           onkeydown="handleCantidadKey(event, ${index})"
                           onchange="cambiarCantidad(${index}, this.value)">
                </td>
                <td class="text-right font-weight-bold text-success">S/ ${subtotal.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-link text-danger btn-sm p-0" onclick="eliminar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        $('#tbodyCarrito').html(html);
        $('#totalPantalla').text(`S/ ${totalVenta.toFixed(2)}`);
        
        if($("#formaPago").val() === 'CREDITO') {
            calcularSaldo();
        }

        // GESTIÓN DEL FOCO AUTOMÁTICO
        if(enfocar && indexFocus !== -1) {
            setTimeout(() => {
                let input = document.getElementById(`cant_${indexFocus}`);
                if(input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }
    }

    // --- LÓGICA DE TECLADO (CORE DEL POS) ---

    function handleCantidadKey(e, index) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // ENTER = SUMAR 1
            let input = document.getElementById(`cant_${index}`);
            let val = parseFloat(input.value) || 0;
            
            carrito[index].cantidad = val + 1;
            dibujarCarrito(true, index);
        }
        
        if (e.key === 'Tab') {
            e.preventDefault();
            
            // TAB = VOLVER AL BUSCADOR Y ENFOCAR PARA ESCRIBIR
            $('#busquedaAjax').select2('open');
            
            setTimeout(() => {
                let searchField = document.querySelector('.select2-container--open .select2-search__field');
                if (searchField) {
                    searchField.focus();
                }
            }, 50);
        }
    }

    function cambiarCantidad(index, val) {
        let cant = parseInt(val);
        if(cant < 1) cant = 1;
        carrito[index].cantidad = cant;
        
        // Recalcular total sin perder foco
        totalVenta = carrito.reduce((acc, i) => acc + (i.cantidad * i.precio), 0);
        $('#totalPantalla').text(`S/ ${totalVenta.toFixed(2)}`);
        
        if($("#formaPago").val() === 'CREDITO') {
            calcularSaldo();
        }
    }

    async function cambiarPrecio(index, nuevoPrecio) {
        let item = carrito[index];
        let precio = parseFloat(nuevoPrecio);

        if(precio < item.precioMin) {
            const { value: pass } = await Swal.fire({
                title: 'AUTORIZACIÓN REQUERIDA',
                text: `El precio mínimo es S/ ${item.precioMin.toFixed(2)}. Ingrese clave de Supervisor:`,
                input: 'password',
                icon: 'warning',
                showCancelButton: true
            });

            if (pass === '1234') { 
                item.precio = precio;
            } 
        } else {
            item.precio = precio;
        }
        dibujarCarrito();
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        dibujarCarrito();
    }

    // --- FUNCIONES DE PAGO ---

    function toggleCredito() {
        let tipo = $("#formaPago").val();
        if(tipo === 'CREDITO') {
            $(".div-credito").removeClass('d-none');
            calcularSaldo();
        } else {
            $(".div-credito").addClass('d-none');
        }
    }

    function calcularSaldo() {
        let inicial = parseFloat($("#montoInicial").val()) || 0;
        let saldo = totalVenta - inicial;
        if(saldo < 0) saldo = 0;
        $("#lblSaldo").text('S/ ' + saldo.toFixed(2));
    }

    function limpiar() {
        if(confirm('¿Limpiar venta?')) {
            carrito = [];
            dibujarCarrito();
            $("#cliente").val('');
            $("#clienteDoc").val('');
            $("#formaPago").val("CONTADO").trigger('change');
            $("#montoInicial").val("0.00");
            $('#busquedaAjax').select2('open');
        }
    }

    function procesarVenta() {
        if(carrito.length === 0) return Swal.fire('Error', 'Carrito vacío', 'warning');

        let formaPago = $("#formaPago").val();
        let doc = $("#clienteDoc").val();
        if (formaPago === 'CREDITO' && (!doc || doc.length < 8)) {
            return Swal.fire('Faltan Datos', 'Para crédito es obligatorio DNI/RUC', 'warning');
        }

        let dto = {
            clienteNombre: $("#cliente").val() || 'CLIENTE VARIOS',
            clienteDocumento: $("#clienteDoc").val() || '00000000',
            tipoComprobante: $("#tipoComprobante").val(),
            formaPago: formaPago,
            montoInicial: parseFloat($("#montoInicial").val()) || 0,
            diasCredito: parseInt($("#diasCredito").val()) || 7,
            items: carrito.map(i => ({ productoId: i.id, cantidad: i.cantidad, precioVenta: i.precio }))
        };

        $.ajax({
            url: '/ventas/api/guardar',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(resp) {
                Swal.fire({
                    title: '¡Venta Exitosa!',
                    text: 'Comprobante generado',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    imprimirPopup('/ventas/imprimir/' + resp.id);
                    carrito = [];
                    dibujarCarrito();
                    $("#cliente").val('');
                    $("#clienteDoc").val('');
                    $("#formaPago").val("CONTADO").trigger('change');
                    $("#montoInicial").val("0.00");
                    $('#busquedaAjax').select2('open');
                });
            },
            error: function(err) {
                Swal.fire('Error', err.responseText, 'error');
            }
        });
    }

    function imprimirPopup(url) {
        const width = 900;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(url, 'Comprobante', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
    }

    function reportarSinStock() {
        Swal.fire({
            title: 'Reportar Falta de Stock',
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Registrar'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                $.post('/ventas/api/solicitar-stock', { producto: result.value }, function(resp) {
                    Swal.fire('Registrado', resp, 'success');
                });
            }
        });
    }
</script>
</body>
</html>