<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='pos')}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid"><h1>Punto de Venta (POS)</h1></div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-primary card-outline" style="height: 100%;">
                            <div class="card-header border-0">
                                <div class="row">
                                    <div class="col-md-8">
                                        <select id="busquedaAjax" class="form-control select2" style="width: 100%;"></select>
                                    </div>
                                    <div class="col-md-4 text-right">
                                        <h3 class="m-0 font-weight-bold text-success" id="totalPantalla">S/ 0.00</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-body table-responsive p-0">
                                <table class="table table-striped table-valign-middle">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th class="text-center" width="15%">Cant.</th>
                                            <th class="text-right" width="20%">Precio</th>
                                            <th class="text-right" width="20%">Subtotal</th>
                                            <th width="5%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyCarrito"></tbody>
                                </table>
                            </div>

                            <div class="card-footer bg-white">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Tipo Doc.</label>
                                        <select id="tipoComprobante" class="form-control form-control-sm">
                                            <option value="NOTA_VENTA">NOTA VENTA</option>
                                            <option value="BOLETA">BOLETA</option>
                                            <option value="FACTURA">FACTURA</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label>DNI / RUC</label>
                                        <input type="text" id="clienteDoc" class="form-control form-control-sm" placeholder="00000000">
                                    </div>
                                    <div class="col-md-6">
                                        <label>Cliente</label>
                                        <input type="text" id="cliente" class="form-control form-control-sm" placeholder="Nombre / Razón Social">
                                    </div>
                                </div>

                                <hr>

                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <label>Condición Pago</label>
                                        <select id="formaPago" class="form-control font-weight-bold" onchange="toggleCredito()">
                                            <option value="CONTADO">CONTADO</option>
                                            <option value="CREDITO">CRÉDITO / CUOTAS</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 div-credito d-none">
                                        <label>Días Crédito</label>
                                        <select id="diasCredito" class="form-control">
                                            <option value="7">7 Días</option>
                                            <option value="15">15 Días</option>
                                            <option value="30">30 Días</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 div-credito d-none">
                                        <label>A Cuenta (S/)</label>
                                        <input type="number" id="montoInicial" class="form-control text-right" value="0.00" onkeyup="calcularSaldo()">
                                    </div>
                                    <div class="col-md-3 div-credito d-none text-right">
                                        <small>Saldo Pendiente:</small>
                                        <h5 class="text-danger font-weight-bold" id="lblSaldo">S/ 0.00</h5>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-12 text-right">
                                        <button class="btn btn-app bg-danger" onclick="limpiar()">
                                            <i class="fas fa-trash"></i> LIMPIAR
                                        </button>
                                        <button class="btn btn-app bg-success" onclick="procesarVenta()">
                                            <i class="fas fa-cash-register"></i> COBRAR
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-widget widget-user">
                            <div class="widget-user-header bg-info">
                                <h5 class="widget-user-username" id="visorNombre">Seleccione un producto</h5>
                                <h6 class="widget-user-desc" id="visorMarca">-</h6>
                            </div>
                            <div class="widget-user-image">
                                <img class="img-circle elevation-2" id="visorImagen" 
                                     src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0PSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGR5PSIuM2VtIiBmaWxsPSIjNTU1IiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5MSUI8L3RleHQ+PC9zdmc+" 
                                     alt="Img" style="width: 90px; height: 90px; object-fit: cover; background: white;">
                            </div>
                            <div class="card-footer p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link">Precio Público <span class="float-right badge bg-primary" id="visorPrecio">S/ 0.00</span></a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link">Stock Disponible <span class="float-right badge bg-success" id="visorStock">0</span></a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link">Ubicación <span class="float-right text-muted" id="visorUbicacion">-</span></a>
                                    </li>
                                </ul>
                                <div class="p-3">
                                    <label>Cantidad a Vender:</label>
                                    <div class="input-group mb-3">
                                        <input type="number" id="inputCantidad" class="form-control form-control-lg text-center" value="1" min="1">
                                        <div class="input-group-append">
                                            <button class="btn btn-success" type="button" onclick="agregarDesdeVisor()">
                                                <i class="fas fa-plus"></i> AGREGAR
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>
<script>
    let carrito = [];
    let productoActual = null;
    let totalVenta = 0;

    const IMG_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cmVjdCB3aWR0PSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGR5PSIuM2VtIiBmaWxsPSIjNTU1IiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OTzwvdGV4dD48L3N2Zz4=";

    $(document).ready(function() {
        $('#busquedaAjax').select2({
            theme: 'bootstrap4',
            placeholder: 'Escanear código o buscar...',
            minimumInputLength: 2, 
            ajax: {
                url: '/ventas/api/buscar-productos',
                dataType: 'json',
                delay: 250,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { return { results: data }; },
                cache: true
            }
        });

        $('#busquedaAjax').on('select2:select', function (e) {
            let data = e.params.data;
            cargarVisor(data);
            $(this).val(null).trigger('change');
        });
    });

    function toggleCredito() {
        let tipo = $("#formaPago").val();
        if(tipo === 'CREDITO') {
            $(".div-credito").removeClass('d-none');
            calcularSaldo();
        } else {
            $(".div-credito").addClass('d-none');
        }
    }

    function calcularSaldo() {
        let inicial = parseFloat($("#montoInicial").val()) || 0;
        let saldo = totalVenta - inicial;
        if(saldo < 0) saldo = 0;
        $("#lblSaldo").text('S/ ' + saldo.toFixed(2));
    }

    function cargarVisor(data) {
        productoActual = data;
        $("#visorNombre").text(data.nombre);
        $("#visorMarca").text(data.marca || 'Genérico');
        $("#visorPrecio").text('S/ ' + parseFloat(data.precio).toFixed(2));
        $("#visorStock").text(data.stock);
        $("#visorUbicacion").text(data.ubicacion);
        
        if(data.imagen) $("#visorImagen").attr("src", "/images/" + data.imagen);
        else $("#visorImagen").attr("src", IMG_PLACEHOLDER);

        $("#inputCantidad").val(1).focus().select();
    }

    function agregarDesdeVisor() {
        if(!productoActual) return;
        let cant = parseInt($("#inputCantidad").val());
        
        if(cant > productoActual.stock) {
            Swal.fire('Stock Insuficiente', 'Solo quedan ' + productoActual.stock, 'warning');
            return;
        }

        let existente = carrito.find(i => i.id === productoActual.id);
        if(existente) existente.cantidad += cant;
        else {
            carrito.push({
                id: productoActual.id,
                nombre: productoActual.nombre,
                precio: parseFloat(productoActual.precio),
                precioMin: parseFloat(productoActual.precioMin),
                cantidad: cant
            });
        }
        dibujarCarrito();
    }

    function dibujarCarrito() {
        let html = '';
        totalVenta = 0; 
        
        carrito.forEach((item, index) => {
            let subtotal = item.precio * item.cantidad;
            totalVenta += subtotal;
            
            html += `<tr>
                <td>${item.nombre}</td>
                <td>
                    <input type="number" class="form-control form-control-sm text-center" value="${item.cantidad}" onchange="cambiarCantidad(${index}, this.value)">
                </td>
                <td>
                    <input type="number" step="0.10" class="form-control form-control-sm text-right" 
                           value="${item.precio.toFixed(2)}" 
                           onchange="cambiarPrecio(${index}, this.value)">
                </td>
                <td class="text-right font-weight-bold">S/ ${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-xs btn-danger" onclick="eliminar(${index})"><i class="fas fa-times"></i></button></td>
            </tr>`;
        });

        $("#tbodyCarrito").html(html);
        $("#totalPantalla").text('S/ ' + totalVenta.toFixed(2));
        if($("#formaPago").val() === 'CREDITO') {
            calcularSaldo();
        }
    }

    function cambiarCantidad(index, val) {
        let cant = parseInt(val);
        if(cant < 1) cant = 1;
        carrito[index].cantidad = cant;
        dibujarCarrito();
    }

    async function cambiarPrecio(index, nuevoPrecio) {
        let item = carrito[index];
        let precio = parseFloat(nuevoPrecio);

        if(precio < item.precioMin) {
            const { value: pass } = await Swal.fire({
                title: 'AUTORIZACIÓN REQUERIDA',
                text: `El precio mínimo es S/ ${item.precioMin.toFixed(2)}. Ingrese clave de Supervisor:`,
                input: 'password',
                icon: 'warning',
                showCancelButton: true
            });

            if (pass === '1234') { 
                item.precio = precio;
            } 
        } else {
            item.precio = precio;
        }
        dibujarCarrito();
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        dibujarCarrito();
    }

    function limpiar() {
        carrito = [];
        dibujarCarrito();
        $("#cliente").val('');
        $("#clienteDoc").val('');
        $("#formaPago").val("CONTADO").trigger('change');
        $("#montoInicial").val("0.00");
    }

    function procesarVenta() {
        if(carrito.length === 0) return Swal.fire('Error', 'Carrito vacío', 'warning');

        let formaPago = $("#formaPago").val();
        let doc = $("#clienteDoc").val();
        if (formaPago === 'CREDITO' && (!doc || doc.length < 8)) {
            return Swal.fire('Faltan Datos', 'Para crédito es obligatorio DNI/RUC', 'warning');
        }

        let dto = {
            clienteNombre: $("#cliente").val() || 'CLIENTE VARIOS',
            clienteDocumento: $("#clienteDoc").val() || '00000000',
            tipoComprobante: $("#tipoComprobante").val(),
            formaPago: formaPago,
            montoInicial: parseFloat($("#montoInicial").val()) || 0,
            diasCredito: parseInt($("#diasCredito").val()) || 7,
            items: carrito.map(i => ({ productoId: i.id, cantidad: i.cantidad, precioVenta: i.precio }))
        };

        $.ajax({
            url: '/ventas/api/guardar',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(resp) {
                Swal.fire({
                    title: '¡Venta Exitosa!',
                    text: 'Comprobante generado',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    // AQUÍ ESTÁ EL CAMBIO CLAVE: IMPRIMIR EN POPUP
                    imprimirPopup('/ventas/imprimir/' + resp.id);
                    limpiar();
                });
            },
            error: function(err) {
                Swal.fire('Error', err.responseText, 'error');
            }
        });
    }

    // FUNCIÓN PARA IMPRIMIR SIN ABRIR PESTAÑA (POPUP)
    function imprimirPopup(url) {
        const width = 900;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        const ventana = window.open(url, 'Comprobante', `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`);
        // Opcional: Si quieres que se cierre automático tras imprimir, se configura en el HTML del comprobante
    }

    function reportarSinStock() {
        Swal.fire({
            title: 'Reportar Falta de Stock',
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Registrar'
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                $.post('/ventas/api/solicitar-stock', { producto: result.value }, function(resp) {
                    Swal.fire('Registrado', resp, 'success');
                });
            }
        });
    }
</script>
</body>
</html>