<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">

<head>
    <title>Importar Productos - Sistema</title>
</head>

<body>
<section layout:fragment="content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0"><i class="fas fa-file-import text-success mr-2"></i>Importar Productos desde Excel</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="/productos">Productos</a></li>
                        <li class="breadcrumb-item active">Importar</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <!-- Instrucciones -->
                <div class="col-lg-6">
                    <div class="card card-outline card-info">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Instrucciones</h3>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="time-label">
                                    <span class="bg-info">Paso a Paso</span>
                                </div>
                                <div>
                                    <i class="fas fa-download bg-primary"></i>
                                    <div class="timeline-item">
                                        <h3 class="timeline-header">1. Descarga la Plantilla</h3>
                                        <div class="timeline-body">
                                            <p>Haz clic en el boton "Descargar Plantilla" para obtener el formato correcto.</p>
                                            <a href="/productos/plantilla-excel" class="btn btn-primary btn-sm">
                                                <i class="fas fa-download mr-1"></i>Descargar Plantilla Excel
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <i class="fas fa-edit bg-warning"></i>
                                    <div class="timeline-item">
                                        <h3 class="timeline-header">2. Completa los Datos</h3>
                                        <div class="timeline-body">
                                            <p>Abre el archivo Excel y llena tus productos. Solo el <strong>NOMBRE</strong> es obligatorio.</p>
                                            <ul class="mb-0">
                                                <li>Fila 1: Encabezados (no modificar)</li>
                                                <li>Fila 2: Instrucciones</li>
                                                <li>Fila 3: Ejemplo (puedes eliminarlo)</li>
                                                <li>Fila 4 en adelante: Tus productos</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <i class="fas fa-upload bg-success"></i>
                                    <div class="timeline-item">
                                        <h3 class="timeline-header">3. Sube el Archivo</h3>
                                        <div class="timeline-body">
                                            Usa el formulario de la derecha para subir tu archivo Excel completado.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos del Excel -->
                    <div class="card card-outline card-secondary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list mr-2"></i>Campos Disponibles</h3>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Campo</th>
                                        <th>Obligatorio</th>
                                        <th>Descripcion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>CODIGO_BARRAS</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Codigo de barras del producto</td>
                                    </tr>
                                    <tr>
                                        <td>CODIGO_INTERNO</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>SKU o codigo interno</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>NOMBRE</strong></td>
                                        <td><span class="badge badge-danger">OBLIGATORIO</span></td>
                                        <td>Nombre del producto</td>
                                    </tr>
                                    <tr>
                                        <td>CATEGORIA</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Categoria o familia</td>
                                    </tr>
                                    <tr>
                                        <td>MARCA</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Marca del producto</td>
                                    </tr>
                                    <tr>
                                        <td>MODELO</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Modelo o referencia</td>
                                    </tr>
                                    <tr>
                                        <td>PRECIO_COMPRA</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Precio de compra (costo)</td>
                                    </tr>
                                    <tr>
                                        <td>PRECIO_VENTA</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Precio de venta al publico</td>
                                    </tr>
                                    <tr>
                                        <td>STOCK_ACTUAL</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Cantidad en stock (default: 0)</td>
                                    </tr>
                                    <tr>
                                        <td>STOCK_MINIMO</td>
                                        <td><span class="badge badge-secondary">Opcional</span></td>
                                        <td>Stock minimo para alerta (default: 5)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Formulario de carga -->
                <div class="col-lg-6">
                    <div class="card card-outline card-success">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-upload mr-2"></i>Subir Archivo Excel</h3>
                        </div>
                        <form action="/productos/importar" method="post" enctype="multipart/form-data">
                            <div class="card-body">
                                <!-- Alertas -->
                                <div th:if="${error}" class="alert alert-danger alert-dismissible">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    <i class="fas fa-exclamation-triangle mr-2"></i><span th:text="${error}"></span>
                                </div>

                                <!-- Zona de arrastre -->
                                <div class="form-group">
                                    <label>Archivo Excel (.xlsx)</label>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="archivo" name="archivo"
                                               accept=".xlsx,.xls" required>
                                        <label class="custom-file-label" for="archivo">Seleccionar archivo...</label>
                                    </div>
                                    <small class="form-text text-muted">
                                        Formatos aceptados: .xlsx, .xls (maximo 10MB)
                                    </small>
                                </div>

                                <!-- Opciones -->
                                <div class="form-group">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="actualizarExistentes"
                                               name="actualizarExistentes" value="true">
                                        <label class="custom-control-label" for="actualizarExistentes">
                                            <strong>Actualizar productos existentes</strong>
                                        </label>
                                        <small class="form-text text-muted">
                                            Si un producto ya existe (mismo codigo de barras o codigo interno),
                                            se actualizaran sus datos. Si no marca esta opcion, se omitiran los duplicados.
                                        </small>
                                    </div>
                                </div>

                                <!-- Preview del archivo -->
                                <div id="previewArchivo" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-file-excel mr-2"></i>
                                    <span id="nombreArchivo"></span>
                                    <span id="tamanoArchivo" class="float-right badge badge-info"></span>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="submit" class="btn btn-success btn-lg btn-block" id="btnImportar">
                                    <i class="fas fa-upload mr-2"></i>Importar Productos
                                </button>
                                <a href="/productos" class="btn btn-secondary btn-block">
                                    <i class="fas fa-arrow-left mr-1"></i>Volver a Productos
                                </a>
                            </div>
                        </form>
                    </div>

                    <!-- Tips -->
                    <div class="card card-outline card-warning">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-lightbulb mr-2"></i>Consejos</h3>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li><strong>Para actualizar precios:</strong> Exporta tus productos, modifica los precios en Excel, y vuelve a importar marcando "Actualizar existentes".</li>
                                <li class="mt-2"><strong>Si tienes un proveedor con lista de precios:</strong> Copia las columnas que necesites a la plantilla.</li>
                                <li class="mt-2"><strong>Stock inicial:</strong> Puedes importar productos con stock 0 e ir ajustando despues con el modulo de inventario.</li>
                                <li class="mt-2"><strong>Codigos unicos:</strong> El codigo de barras y codigo interno deben ser unicos. Si se repiten, el sistema detectara duplicados.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</section>

<th:block layout:fragment="scripts">
<script>
$(document).ready(function() {
    // Mostrar nombre del archivo seleccionado
    $('#archivo').on('change', function() {
        var fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(fileName);

        if (this.files && this.files[0]) {
            var file = this.files[0];
            var sizeMB = (file.size / (1024 * 1024)).toFixed(2);

            $('#nombreArchivo').text(file.name);
            $('#tamanoArchivo').text(sizeMB + ' MB');
            $('#previewArchivo').show();

            // Validar tamano
            if (file.size > 10 * 1024 * 1024) {
                Swal.fire({
                    icon: 'error',
                    title: 'Archivo muy grande',
                    text: 'El archivo no puede superar los 10MB'
                });
                $(this).val('');
                $('#previewArchivo').hide();
            }
        }
    });

    // Confirmacion antes de importar
    $('form').on('submit', function(e) {
        var actualizarExistentes = $('#actualizarExistentes').is(':checked');
        var mensaje = actualizarExistentes
            ? 'Se crearan nuevos productos y se actualizaran los existentes. ¿Continuar?'
            : 'Se crearan nuevos productos. Los duplicados seran omitidos. ¿Continuar?';

        if (!confirm(mensaje)) {
            e.preventDefault();
            return false;
        }

        $('#btnImportar').prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin mr-2"></i>Importando...');
    });
});
</script>
</th:block>
</body>
</html>
