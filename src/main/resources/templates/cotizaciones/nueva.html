<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>

<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">
    
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='nueva_cotizacion')}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid"><h1>Gestión de Cotización</h1></div>
        </section>

        <section class="content p-3">
            <div class="row">
                <div class="col-md-8">
                    <div class="card card-warning card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-edit"></i> 
                                <span th:text="${cotizacionEdicion != null ? 'Editando Cotización ' + cotizacionEdicion.serie + '-' + cotizacionEdicion.numero : 'Nueva Cotización'}"></span>
                            </h3>
                            <input type="hidden" id="idEdicion" th:value="${cotizacionEdicion != null ? cotizacionEdicion.id : ''}">
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <label>Agregar Producto</label>
                                    <div class="input-group">
                                        <select id="selectProducto" class="form-control select2" style="width: 85%;"></select>
                                        <div class="input-group-append">
                                            <button class="btn btn-success" type="button" onclick="agregarSeleccionado()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <label>O Servicios / Mano de Obra</label>
                                    <button class="btn btn-info btn-block" onclick="agregarServicioManual()">
                                        <i class="fas fa-tools"></i> AGREGAR SERVICIO
                                    </button>
                                </div>
                            </div>

                            <table class="table table-bordered table-striped">
                                <thead class="bg-navy">
                                    <tr>
                                        <th width="40%">Descripción / Producto</th>
                                        <th width="15%">Precio Unit.</th>
                                        <th width="10%">Cant.</th>
                                        <th width="15%">Subtotal</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="tablaVentas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-header">Datos del Cliente</div>
                        <div class="card-body">
                            <input type="text" id="clienteDoc" class="form-control mb-2" placeholder="DNI / RUC" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteDocumento : ''}">
                            <input type="text" id="clienteNombre" class="form-control mb-2" placeholder="Nombre Cliente" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteNombre : 'CLIENTE VARIOS'}">
                            <input type="text" id="clienteTelefono" class="form-control mb-2" placeholder="WhatsApp (Opcional)" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteTelefono : ''}">

                            <hr>
                            <h2 class="text-right font-weight-bold" id="lblTotal">S/ 0.00</h2>
                            
                            <button class="btn btn-primary btn-block btn-lg mb-2" onclick="guardarCotizacion(true)">
                                <i class="fas fa-save"></i> <span th:text="${cotizacionEdicion != null ? 'GUARDAR CAMBIOS' : 'GUARDAR'}"></span>
                            </button>
                            
                            <button th:if="${cotizacionEdicion != null}" class="btn btn-warning btn-block btn-lg" onclick="convertirDirecto()">
                                <i class="fas fa-exchange-alt"></i> ACTUALIZAR Y VENDER
                            </button>

                            <button th:if="${cotizacionEdicion != null}" class="btn btn-default btn-block mt-2" 
                                    th:onclick="abrirPdf([[${cotizacionEdicion.id}]])">
                                <i class="fas fa-print"></i> VISTA PREVIA PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    let carrito = [];
    // ID genérico para servicios si no se encuentra en BD
    let ID_SERVICIO_GENERAL = 1; 

    $(document).ready(function() {
        // Inicializar Select2 con AJAX (Velocidad)
        $('#selectProducto').select2({
            theme: 'bootstrap4',
            placeholder: "Buscar producto...",
            allowClear: true,
            ajax: {
                url: '/ventas/api/buscar-productos',
                dataType: 'json',
                delay: 250,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { 
                    // Mapeamos para que Select2 entienda
                    return { 
                        results: data.map(p => ({
                            id: p.id,
                            text: p.text,
                            producto: p // Guardamos todo el objeto para usarlo luego
                        })) 
                    }; 
                },
                cache: true
            }
        });

        // Evento: Al seleccionar, guardamos temporalmente el dato pero NO agregamos hasta dar click al botón (si así lo prefieres)
        // Opcional: Si quieres agregar directo al seleccionar, descomenta la línea 'agregarAlCarrito'
        $('#selectProducto').on('select2:select', function (e) {
            // let data = e.params.data.producto;
            // agregarAlCarrito(data); 
            // $('#selectProducto').val(null).trigger('change');
        });

        /*[+
        // Cargar datos si estamos editando
        let cotiEdit = [[${cotizacionEdicion}]];
        if(cotiEdit) {
            cotiEdit.items.forEach(item => {
                carrito.push({
                    id: item.producto.id,
                    nombre: item.descripcion || item.producto.nombre,
                    precio: item.precioUnitario,
                    cantidad: item.cantidad,
                    esServicio: (item.producto.codigoInterno === 'SERV-001')
                });
            });
            renderizarTablaCoti();
        }
        +]*/
    });

    // RECUPERADO: Función del botón "+"
    function agregarSeleccionado() {
        let data = $('#selectProducto').select2('data');
        if(data && data.length > 0) {
            let prod = data[0].producto;
            agregarAlCarrito(prod);
            $('#selectProducto').val(null).trigger('change');
        } else {
            Swal.fire('Atención', 'Busque y seleccione un producto primero', 'warning');
        }
    }

    function agregarAlCarrito(prod) {
        let existente = carrito.find(i => i.id == prod.id);
        if(existente) existente.cantidad++;
        else {
            carrito.push({
                id: prod.id,
                // Limpiamos el texto que viene del select2 (ej: "COD - Nombre (Stock)")
                nombre: prod.nombre, 
                precio: prod.precio,
                cantidad: 1,
                esServicio: false
            });
        }
        renderizarTablaCoti();
    }

    function agregarServicioManual() {
        // Intentamos buscar el ID del servicio si existe en backend, sino usamos default
        $.get('/ventas/api/buscar-productos?term=SERV-001', function(data) {
            let idServ = (data && data.length > 0) ? data[0].id : ID_SERVICIO_GENERAL;
            
            carrito.push({
                id: idServ,
                nombre: "SERVICIO: ...", 
                precio: 0.00,
                cantidad: 1,
                esServicio: true
            });
            renderizarTablaCoti();
        });
    }

    function renderizarTablaCoti() {
        let html = '';
        let total = 0;
        carrito.forEach((item, index) => {
            let subtotal = item.cantidad * item.precio;
            total += subtotal;
            
            // RECUPERADO: Input para editar nombre si es servicio
            let inputNombre = item.esServicio 
                ? `<input type="text" class="form-control form-control-sm" value="${item.nombre}" onchange="actualizarItem(${index}, 'nombre', this.value)">`
                : item.nombre;

            html += `<tr>
                <td>${inputNombre}</td>
                <td><input type="number" step="0.01" class="form-control form-control-sm" value="${item.precio}" onchange="actualizarItem(${index}, 'precio', this.value)"></td>
                <td><input type="number" class="form-control form-control-sm" value="${item.cantidad}" onchange="actualizarItem(${index}, 'cant', this.value)"></td>
                <td class="font-weight-bold">S/ ${subtotal.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="eliminarItem(${index})"><i class="fas fa-times"></i></button></td>
            </tr>`;
        });
        $('#tablaVentas').html(html);
        $('#lblTotal').text(`S/ ${total.toFixed(2)}`);
    }

    function actualizarItem(index, campo, valor) {
        if(campo === 'nombre') carrito[index].nombre = valor;
        if(campo === 'precio') carrito[index].precio = parseFloat(valor) || 0;
        if(campo === 'cant') carrito[index].cantidad = parseFloat(valor) || 1;
        renderizarTablaCoti();
    }

    function eliminarItem(index) {
        carrito.splice(index, 1);
        renderizarTablaCoti();
    }

    function abrirPdf(id) {
        window.open('/cotizaciones/imprimir/' + id, '_blank', 'width=900,height=700');
    }

    function guardarCotizacion(redireccionar = true) {
        if(carrito.length === 0) return Swal.fire('Error', 'Carrito vacío', 'warning');
        
        let dto = { 
            clienteDocumento: $('#clienteDoc').val(),
            clienteNombre: $('#clienteNombre').val(), 
            clienteTelefono: $('#clienteTelefono').val(),
            items: carrito.map(i => ({
                productoId: i.id,
                cantidad: i.cantidad,
                precioVenta: i.precio, // RECUPERADO: Usar precioVenta como espera el DTO
                descripcion: i.esServicio ? i.nombre : null 
            }))
        };
        
        let idEdicion = $('#idEdicion').val();
        let url = idEdicion ? '/cotizaciones/api/actualizar/' + idEdicion : '/cotizaciones/api/guardar';
        let method = idEdicion ? 'PUT' : 'POST';

        $.ajax({
            url: url, type: method, contentType: 'application/json', data: JSON.stringify(dto),
            success: function(resp) {
                if(redireccionar) {
                    Swal.fire('Guardado', 'Correcto', 'success').then(() => {
                        if(idEdicion) location.reload(); 
                        else window.location.href = '/cotizaciones/lista';
                    });
                }
            },
            error: function(err) { Swal.fire('Error', 'Fallo al guardar', 'error'); }
        });
    }
    
    // Función para convertir desde edición
    function convertirDirecto() {
        let id = $('#idEdicion').val();
        guardarCotizacion(false); // Guardar cambios primero silenciosamente
        
        Swal.fire({
            title: 'Generar Venta',
            text: "¿Boleta o Factura?",
            icon: 'question',
            showDenyButton: true,
            confirmButtonText: 'BOLETA',
            denyButtonText: 'FACTURA'
        }).then((result) => {
            if (result.isConfirmed || result.isDenied) {
                let tipo = result.isConfirmed ? 'BOLETA' : 'FACTURA';
                $.post(`/cotizaciones/api/convertir/${id}?tipo=${tipo}`, function(resp) {
                    Swal.fire('¡Vendido!', `Venta ID: ${resp.ventaId}`, 'success')
                        .then(() => window.location.href = '/ventas/lista');
                });
            }
        });
    }
</script>
</body>
</html>