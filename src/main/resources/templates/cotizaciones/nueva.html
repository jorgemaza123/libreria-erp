<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/layout :: head}"></div>
    <style>
        /* FONDO Y CENTRADO */
        .content-wrapper { background-color: #e9ecef; } /* Fondo un poco más oscuro para resaltar los rectángulos */
        
        /* RECTÁNGULO CENTRAL (PRODUCTOS) */
        .card-main {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            height: 85vh; /* Altura fija para mantener consistencia */
            display: flex;
            flex-direction: column;
        }

        /* RECTÁNGULO LATERAL (DATOS Y TOTAL) */
        .card-side {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            background: white;
            position: sticky;
            top: 10px;
        }

        /* TOTAL GIGANTE */
        .total-box {
            background: #2c3e50;
            color: #2ecc71;
            padding: 15px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .total-amount { font-size: 2.5rem; font-weight: 800; font-family: monospace; }
        .total-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #bdc3c7; }

        /* TABLA COMPACTA */
        .table-pos thead th { background-color: #34495e; color: white; padding: 8px; }
        .table-pos td { vertical-align: middle !important; padding: 5px !important; }
        
        /* INPUTS EN TABLA (CANTIDAD) */
        .input-qty {
            width: 70px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .input-qty:focus {
            border-color: #3498db;
            background-color: #ebf5fb;
            outline: none;
        }

        /* BUSCADOR SELECT2 */
        .select2-container .select2-selection--single { height: 45px !important; }
        .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered { 
            line-height: 43px !important; font-size: 1.2rem; 
        }
        /* Resaltar fila activa */
        .table-active-row { background-color: #fff3cd !important; }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">
    
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='nueva_cotizacion')}"></aside>

    <div class="content-wrapper d-flex justify-content-center pt-3">
        
        <div class="container-fluid" style="max-width: 1600px;">
            <input type="hidden" id="idEdicion" th:value="${cotizacionEdicion != null ? cotizacionEdicion.id : ''}">

            <div class="row">
                
                <div class="col-lg-9 col-md-8">
                    <div class="card card-main">
                        <div class="card-header bg-white border-bottom-0 pt-3 px-4">
                            <h5 class="text-secondary mb-3"><i class="fas fa-barcode"></i> Búsqueda de Productos</h5>
                            <div class="row">
                                <div class="col-md-10">
                                    <select id="selectProducto" class="form-control" style="width: 100%;"></select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary btn-block" style="height: 45px;" onclick="agregarServicioManual()">
                                        <i class="fas fa-plus"></i> Otro
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0 table-responsive flex-grow-1">
                            <table class="table table-pos table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">#</th>
                                        <th style="width: 55%">Producto / Descripción</th>
                                        <th style="width: 15%" class="text-right">Precio</th>
                                        <th style="width: 10%" class="text-center">Cant.</th>
                                        <th style="width: 10%" class="text-right">Total</th>
                                        <th style="width: 5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="tablaVentas">
                                    </tbody>
                            </table>
                            <div id="msgVacio" class="text-center mt-5 text-muted">
                                <i class="fas fa-search fa-3x mb-3 text-gray-300"></i>
                                <p>Busque un producto para comenzar...</p>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-light text-muted small">
                            <i class="fas fa-keyboard"></i> 
                            <b>Enter</b> en buscador: Selecciona | 
                            <b>Enter</b> en Cantidad: Suma 1 | 
                            <b>Tab</b> en Cantidad: Vuelve a buscar
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-4">
                    <div class="card card-side p-3">
                        
                        <div class="total-box">
                            <div class="total-label">Total a Pagar</div>
                            <div class="total-amount" id="lblTotal">S/ 0.00</div>
                        </div>

                        <h6 class="font-weight-bold text-secondary border-bottom pb-2">Datos del Cliente</h6>
                        
                        <div class="form-group mb-2">
                            <label class="small mb-1">DNI / RUC</label>
                            <input type="text" id="clienteDoc" class="form-control" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteDocumento : ''}">
                        </div>
                        
                        <div class="form-group mb-2">
                            <label class="small mb-1">Nombre / Razón Social *</label>
                            <input type="text" id="clienteNombre" class="form-control font-weight-bold" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteNombre : 'CLIENTE VARIOS'}">
                        </div>

                        <div class="form-group mb-3">
                            <label class="small mb-1">Celular (WhatsApp)</label>
                            <input type="text" id="clienteTelefono" class="form-control" 
                                   th:value="${cotizacionEdicion != null ? cotizacionEdicion.clienteTelefono : ''}">
                        </div>

                        <button class="btn btn-primary btn-block btn-lg font-weight-bold shadow-sm mb-2" onclick="guardarCotizacion(true)">
                            <i class="fas fa-save"></i> GUARDAR (F2)
                        </button>
                        
                        <button class="btn btn-default btn-block btn-sm" onclick="limpiarTodo()">
                            <i class="fas fa-eraser"></i> Limpiar Todo
                        </button>

                        <div class="mt-4 text-center" th:if="${cotizacionEdicion != null}">
                            <hr>
                            <button class="btn btn-warning btn-block font-weight-bold" onclick="convertirDirecto()">
                                <i class="fas fa-cash-register"></i> FACTURAR AHORA
                            </button>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    let carrito = [];
    let ID_SERVICIO_GENERAL = 1;

    $(document).ready(function() {
        // --- 1. CONFIGURACIÓN DEL BUSCADOR (SELECT2) ---
        $('#selectProducto').select2({
            theme: 'bootstrap4',
            placeholder: "Escribe aquí para buscar...",
            allowClear: true,
            minimumInputLength: 1, 
            ajax: {
                url: '/ventas/api/buscar-productos',
                dataType: 'json',
                delay: 50, // Muy rápido
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { 
                    return { 
                        results: data.map(p => ({
                            id: p.id,
                            text: p.text + " (Stock: " + p.stock + ")",
                            producto: p
                        })) 
                    }; 
                }
            }
        });

        // --- 2. LÓGICA DE SELECCIÓN Y FOCO ---
        $('#selectProducto').on('select2:select', function (e) {
            let prod = e.params.data.producto;
            
            // Agregamos al carrito
            agregarAlCarrito(prod);
            
            // Limpiamos el buscador visualmente (pero el foco se moverá a la tabla)
            $('#selectProducto').val(null).trigger('change');
        });

        // --- 3. CARGA DE DATOS (EDICIÓN) ---
        /*[# th:if="${cotizacionEdicion != null}"]*/
            /*[# th:each="item : ${cotizacionEdicion.items}"]*/
            carrito.push({
                id: /*[[${item.producto.id}]]*/ 0,
                nombre: /*[[${item.descripcion != null ? item.descripcion : item.producto.nombre}]]*/ 'Prod',
                precio: /*[[${item.precioUnitario}]]*/ 0,
                cantidad: /*[[${item.cantidad}]]*/ 1,
                esServicio: /*[[${item.producto.codigoInterno == 'SERV-001'}]]*/ false
            });
            /*[/]*/
            renderizarTablaCoti(false); 
        /*[/]*/

        // Foco inicial al buscador al cargar la página
        setTimeout(() => $('#selectProducto').select2('open'), 300);

        // Atajo Global F2 para guardar
        $(document).keydown(function(e) {
            if (e.key === 'F2') {
                e.preventDefault();
                guardarCotizacion(true);
            }
        });
    });

    // --- FUNCIONES DEL CARRITO ---

    function agregarAlCarrito(prod) {
        // Buscamos si ya existe
        let index = carrito.findIndex(i => i.id == prod.id);
        
        if(index !== -1) {
            // Si existe, no sumamos 1, solo movemos el foco ahí para que el usuario decida
            renderizarTablaCoti(true, index);
        } else {
            // Nuevo item
            carrito.push({
                id: prod.id,
                nombre: prod.nombre, 
                precio: parseFloat(prod.precio) || 0,
                cantidad: 1, // Cantidad inicial 1
                esServicio: false
            });
            // Renderizamos y ponemos foco en el ÚLTIMO (el nuevo)
            renderizarTablaCoti(true, carrito.length - 1);
        }
    }

    function agregarServicioManual() {
        carrito.push({
            id: ID_SERVICIO_GENERAL,
            nombre: "SERVICIO / VARIOS", 
            precio: 0.00,
            cantidad: 1,
            esServicio: true
        });
        renderizarTablaCoti(true, carrito.length - 1);
    }

    function renderizarTablaCoti(enfocar = false, indexFocus = -1) {
        let html = '';
        let total = 0;

        if (carrito.length === 0) $('#msgVacio').show();
        else $('#msgVacio').hide();

        carrito.forEach((item, index) => {
            let subtotal = item.cantidad * item.precio;
            total += subtotal;
            
            // Highlight si es el que tiene el foco
            let activeClass = (index === indexFocus) ? 'table-active-row' : '';

            let nombreDisplay = item.esServicio 
                ? `<input type="text" class="form-control form-control-sm" value="${item.nombre}" onchange="actDato(${index}, 'nombre', this.value)">`
                : `<span class="font-weight-bold text-dark">${item.nombre}</span>`;

            html += `<tr class="${activeClass}">
                <td class="text-center text-muted">${index + 1}</td>
                <td>${nombreDisplay}</td>
                <td class="text-right">
                    <input type="number" step="0.10" class="form-control form-control-sm text-right border-0 bg-transparent" 
                           value="${item.precio.toFixed(2)}" readonly>
                </td>
                <td class="text-center">
                    <input type="number" id="cant_${index}" class="input-qty" 
                           value="${item.cantidad}" 
                           onkeydown="handleCantidadKey(event, ${index})"
                           onchange="actDato(${index}, 'cant', this.value)">
                </td>
                <td class="text-right font-weight-bold text-success">S/ ${subtotal.toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-link text-danger btn-sm p-0" onclick="eliminarItem(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        $('#tablaVentas').html(html);
        $('#lblTotal').text(`S/ ${total.toFixed(2)}`);

        // GESTIÓN DEL FOCO AUTOMÁTICO
        if(enfocar && indexFocus !== -1) {
            setTimeout(() => {
                let input = document.getElementById(`cant_${indexFocus}`);
                if(input) {
                    input.focus();
                    input.select(); // Selecciona el número para que sea fácil sobreescribir si se desea
                }
            }, 50);
        }
    }

    // --- LÓGICA DE TECLADO (CORE DEL POS) ---

    function handleCantidadKey(e, index) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Evitar submit
            
            // LÓGICA: ENTER = SUMAR 1
            let input = document.getElementById(`cant_${index}`);
            let val = parseFloat(input.value) || 0;
            
            // Actualizar memoria
            carrito[index].cantidad = val + 1;
            
            // Re-renderizar (se verá el cambio de precio) y MANTENER el foco aquí
            renderizarTablaCoti(true, index);
        }
        
        if (e.key === 'Tab') {
    e.preventDefault(); // Evitar salto normal
    
    // LÓGICA: TAB = VOLVER AL BUSCADOR Y ENFOCAR PARA ESCRIBIR
    $('#selectProducto').select2('open');
    
    // Forzar foco en el campo de búsqueda del Select2
    setTimeout(() => {
        let searchField = document.querySelector('.select2-container--open .select2-search__field');
        if (searchField) {
            searchField.focus();
        }
    }, 50);
}
    }

    function actDato(index, campo, valor) {
        if(campo === 'nombre') carrito[index].nombre = valor;
        if(campo === 'cant') carrito[index].cantidad = parseFloat(valor) || 1;
        
        // Recalcular sin perder foco visualmente
        let total = carrito.reduce((acc, i) => acc + (i.cantidad * i.precio), 0);
        $('#lblTotal').text(`S/ ${total.toFixed(2)}`);
        
        // No llamamos a renderizar completo aquí para no molestar al usuario mientras escribe
        // Se renderizará completo cuando presione Enter o Tab
    }

    function eliminarItem(index) {
        carrito.splice(index, 1);
        renderizarTablaCoti();
    }

    function limpiarTodo() {
        if(confirm('¿Limpiar cotización?')) {
            carrito = [];
            renderizarTablaCoti();
            $('#clienteNombre').val('CLIENTE VARIOS');
            $('#clienteDoc').val('');
            $('#clienteTelefono').val('');
            $('#selectProducto').select2('open');
        }
    }

    // --- GUARDAR (Misma lógica) ---
    function guardarCotizacion(redireccionar = true) {
        if(carrito.length === 0) return Swal.fire('Error', 'Agregue productos', 'warning');
        
        let dto = { 
            clienteDocumento: $('#clienteDoc').val(),
            clienteNombre: $('#clienteNombre').val(), 
            clienteTelefono: $('#clienteTelefono').val(),
            items: carrito.map(i => ({
                productoId: i.id, cantidad: i.cantidad, precioVenta: i.precio,
                descripcion: i.esServicio ? i.nombre : null 
            }))
        };
        
        let idEdicion = $('#idEdicion').val();
        let url = idEdicion ? '/cotizaciones/api/actualizar/' + idEdicion : '/cotizaciones/api/guardar';
        let method = idEdicion ? 'PUT' : 'POST';

        Swal.fire({ title: 'Procesando...', didOpen: () => Swal.showLoading() });

        $.ajax({
            url: url, type: method, contentType: 'application/json', data: JSON.stringify(dto),
            success: function(resp) {
                Swal.close();
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: 'Guardado Correctamente' });
                
                if(redireccionar) {
                    setTimeout(() => window.location.href = '/cotizaciones/lista', 500);
                } else {
                    // Resetear para siguiente cliente rápido
                    carrito = [];
                    renderizarTablaCoti();
                    $('#clienteNombre').val('CLIENTE VARIOS');
                    $('#clienteDoc').val('');
                    $('#selectProducto').select2('open');
                }
            },
            error: function(err) { Swal.fire('Error', 'Fallo al guardar', 'error'); }
        });
    }
    
    function convertirDirecto() {
        // Lógica de conversión (reutilizar la que tenías)
        let id = $('#idEdicion').val();
        guardarCotizacion(false);
        setTimeout(() => {
             // ... llamar a tu API de convertir ...
             Swal.fire('Función convertir', 'Implementa tu llamada AJAX aquí', 'info');
        }, 500);
    }
</script>
</body>
</html>