<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='dashboard')}"></aside>

    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0 text-dark">Panel de Control Financiero</h1>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3 id="kpiVentasMes" th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiVentasMes, 1, 2)}"></h3>
                                <p>Ventas del Mes</p>
                            </div>
                            <div class="icon"><i class="fas fa-cash-register"></i></div>
                            <a href="/ventas/lista" class="small-box-footer">Ver detalles <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3 id="kpiCreditos" th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiCreditos, 1, 2)}"></h3>
                                <p>Cuentas por Cobrar</p>
                            </div>
                            <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                            <a href="/cobranzas" class="small-box-footer">Gestionar Cobros <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3 id="kpiInventario" th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiInventario, 1, 2)}"></h3>
                                <p>Valor del Inventario</p>
                            </div>
                            <div class="icon"><i class="fas fa-boxes"></i></div>
                            <a href="/reportes" class="small-box-footer">Ver reporte <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-secondary">
                            <div class="inner">
                                <h3 id="kpiGastos" th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiGastos, 1, 2)}"></h3>
                                <p>Gastos/Compras Mes</p>
                            </div>
                            <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                            <a href="/gastos" class="small-box-footer">Ver gastos <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-navy card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-bar"></i> Balance: Ingresos vs Egresos (6 Meses)</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="chartBalance" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-success card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Top Productos</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="chartTop" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-info card-outline">
                            <div class="card-header"><h3 class="card-title">Modalidad de Venta (Global)</h3></div>
                            <div class="card-body">
                                <canvas id="chartModalidad" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- Widget Contador SUNAT -->
                        <div class="card card-purple card-outline" id="widgetSunat">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-file-invoice"></i> Comprobantes SUNAT
                                    <small class="text-muted" th:text="${sunatStats?.mesAnio}"></small>
                                </h3>
                                <div class="card-tools">
                                    <span th:if="${sunatStats?.sunatActivo}" class="badge badge-success">ACTIVO</span>
                                    <span th:unless="${sunatStats?.sunatActivo}" class="badge badge-secondary">OFFLINE</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Alerta de deuda -->
                                <div th:if="${sunatStats?.tieneDeudaPendiente}" class="alert alert-danger py-1 px-2 mb-2">
                                    <small><i class="fas fa-exclamation-circle"></i> Deuda pendiente: <strong th:text="'S/ ' + ${sunatStats?.deudaTotal}">S/ 0</strong></small>
                                    <a href="/configuracion/sunat-billing" class="btn btn-xs btn-danger float-right">Ver</a>
                                </div>
                                <div class="row">
                                    <div class="col-6 text-center border-right">
                                        <h2 class="text-purple mb-0" id="sunatComprobantes" th:text="${sunatStats?.comprobantesEmitidos ?: 0}">0</h2>
                                        <small class="text-muted">Emitidos</small>
                                    </div>
                                    <div class="col-6 text-center">
                                        <h2 class="mb-0" th:classappend="${(sunatStats?.costoEstimado ?: 0) > 0} ? 'text-warning' : 'text-success'" id="sunatCosto">
                                            <span th:text="${config.formatoMoneda}">S/</span>
                                            <span th:text="${#numbers.formatDecimal(sunatStats?.costoEstimado ?: 0, 1, 2)}">0.00</span>
                                        </h2>
                                        <small class="text-muted">Costo Mes</small>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-between small">
                                    <span><i class="fas fa-receipt text-info"></i> Boletas: <strong th:text="${sunatStats?.boletas ?: 0}">0</strong></span>
                                    <span><i class="fas fa-file-alt text-warning"></i> Facturas: <strong th:text="${sunatStats?.facturas ?: 0}">0</strong></span>
                                    <span><i class="fas fa-gift text-success"></i> Gratis: <strong th:text="${sunatStats?.comprobantesGratisRestantes ?: 20}">20</strong></span>
                                </div>
                                <div class="progress mt-2" style="height: 8px;" title="Uso del limite gratuito (20)">
                                    <div class="progress-bar" role="progressbar"
                                         th:classappend="${(sunatStats?.porcentajeGratisUsado ?: 0) >= 100} ? 'bg-warning' : 'bg-purple'"
                                         th:style="'width: ' + ${sunatStats?.porcentajeGratisUsado ?: 0} + '%'"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted" th:text="${sunatStats?.mensaje}">20 comprobantes gratis</small>
                                    <a href="/configuracion/sunat-billing" class="small"><i class="fas fa-cog"></i> Gestionar</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- Widget Licencia -->
                        <div class="card" th:classappend="${licenseInfo?.estado?.name() == 'ACTIVO' ? 'card-success' : (licenseInfo?.estado?.name() == 'EN_GRACIA' ? 'card-warning' : 'card-danger')} + ' card-outline'">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-key"></i> Estado de Licencia</h3>
                            </div>
                            <div class="card-body text-center">
                                <div th:if="${licenseInfo?.estado?.name() == 'ACTIVO'}">
                                    <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                                    <h4 class="text-success">Licencia Activa</h4>
                                    <p class="mb-0">Vence en <strong th:text="${licenseInfo?.diasRestantes}">0</strong> dias</p>
                                    <small class="text-muted" th:text="${licenseInfo?.fechaVencimiento}"></small>
                                </div>
                                <div th:if="${licenseInfo?.estado?.name() == 'EN_GRACIA'}">
                                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-2"></i>
                                    <h4 class="text-warning">Periodo de Gracia</h4>
                                    <p class="mb-0 text-danger">Vencida hace <strong th:text="${licenseInfo?.diasRestantes * -1}">0</strong> dias</p>
                                    <a href="/licencia" class="btn btn-warning btn-sm mt-2">Renovar Ahora</a>
                                </div>
                                <div th:if="${licenseInfo?.estado?.name() == 'SIN_LICENCIA' or licenseInfo?.estado?.name() == 'BLOQUEADO'}">
                                    <i class="fas fa-ban fa-3x text-danger mb-2"></i>
                                    <h4 class="text-danger">Sin Licencia</h4>
                                    <a href="/licencia" class="btn btn-danger btn-sm mt-2">Activar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card card-danger card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Alerta de Stock Bajo</h3>
                            </div>
                            <div class="card-body table-responsive p-0" style="max-height: 250px;">
                                <table class="table table-head-fixed text-nowrap table-striped">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Categoria</th>
                                            <th>Stock Actual</th>
                                            <th>Minimo</th>
                                            <th>Accion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyStockCritico">
                                        <tr th:each="p : ${stockCritico}">
                                            <td th:text="${p.nombre}"></td>
                                            <td th:text="${p.categoria}"></td>
                                            <td class="text-danger font-weight-bold" th:text="${p.stockActual}"></td>
                                            <td th:text="${p.stockMinimo}"></td>
                                            <td>
                                                <a href="/compras/nueva" class="btn btn-xs btn-primary">Reponer</a>
                                            </td>
                                        </tr>
                                        <tr th:if="${stockCritico.empty}">
                                            <td colspan="5" class="text-center text-muted">Excelente! No hay productos con stock critico.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // 1. DATOS COMPARATIVA
    const rawComparativa = /*[[${comparativa}]]*/ {};
    const labelsComp = Object.keys(rawComparativa);
    const dataIngresos = labelsComp.map(k => rawComparativa[k].ingreso);
    const dataEgresos = labelsComp.map(k => rawComparativa[k].egreso);

    // 2. DATOS TOP
    const rawTop = /*[[${topProductos}]]*/ [];
    
    // 3. DATOS MODALIDAD
    const rawPie = /*[[${pieCredito}]]*/ {};

    $(document).ready(function() {
        
        // GRÁFICO 1: BALANCE (BARRAS) - Colores desde configuración
        new Chart(document.getElementById('chartBalance').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labelsComp,
                datasets: [
                    {
                        label: 'Ingresos (Ventas)',
                        backgroundColor: APP_CONFIG.colorExito,
                        data: dataIngresos
                    },
                    {
                        label: 'Egresos (Gastos/Compras)',
                        backgroundColor: APP_CONFIG.colorPeligro,
                        data: dataEgresos
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{ ticks: { beginAtZero: true, callback: function(value) { return APP_CONFIG.formatoMoneda + ' ' + value; } } }]
                },
                tooltips: {
                    callbacks: { label: function(item) { return APP_CONFIG.formatoMoneda + ' ' + item.yLabel.toFixed(2); } }
                }
            }
        });

        // GRÁFICO 2: TOP PRODUCTOS (DONUT) - Paleta de colores personalizada
        new Chart(document.getElementById('chartTop').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: rawTop.map(d => d.etiqueta),
                datasets: [{
                    data: rawTop.map(d => d.valor),
                    backgroundColor: [
                        APP_CONFIG.colorPeligro,
                        APP_CONFIG.colorExito,
                        APP_CONFIG.colorAdvertencia,
                        APP_CONFIG.colorInfo,
                        APP_CONFIG.colorPrimario
                    ],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, legend: { position: 'right' } }
        });

        // GRÁFICO 3: MODALIDAD (PIE) - Colores desde configuración
        new Chart(document.getElementById('chartModalidad').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Contado', 'Crédito'],
                datasets: [{
                    data: [rawPie.contado, rawPie.credito],
                    backgroundColor: [APP_CONFIG.colorInfo, APP_CONFIG.colorAdvertencia]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // ============================================
        // POLLING - REFRESCO AUTOMATICO
        // ============================================
        iniciarPollingDashboard();
    });

    // Intervalo de polling en milisegundos (30 segundos)
    const DASHBOARD_POLLING_INTERVAL = 30000;
    let dashboardPollingTimer = null;

    function iniciarPollingDashboard() {
        if (dashboardPollingTimer) clearInterval(dashboardPollingTimer);

        dashboardPollingTimer = setInterval(function() {
            console.log('[Dashboard Principal] Actualizando datos...');
            actualizarDashboard();
        }, DASHBOARD_POLLING_INTERVAL);

        console.log('[Dashboard Principal] Polling iniciado - refresco cada ' + (DASHBOARD_POLLING_INTERVAL/1000) + ' segundos');
    }

    function detenerPollingDashboard() {
        if (dashboardPollingTimer) {
            clearInterval(dashboardPollingTimer);
            dashboardPollingTimer = null;
            console.log('[Dashboard Principal] Polling detenido');
        }
    }

    // Detener polling cuando la pestaña no está visible (ahorro de recursos)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            detenerPollingDashboard();
        } else {
            actualizarDashboard();
            iniciarPollingDashboard();
        }
    });

    function actualizarDashboard() {
        $.ajax({
            url: '/api/dashboard/datos',
            method: 'GET',
            success: function(data) {
                // Actualizar KPIs
                $('#kpiVentasMes').text(APP_CONFIG.formatoMoneda + ' ' + parseFloat(data.kpiVentasMes || 0).toFixed(2));
                $('#kpiCreditos').text(APP_CONFIG.formatoMoneda + ' ' + parseFloat(data.kpiCreditos || 0).toFixed(2));
                $('#kpiInventario').text(APP_CONFIG.formatoMoneda + ' ' + parseFloat(data.kpiInventario || 0).toFixed(2));
                $('#kpiGastos').text(APP_CONFIG.formatoMoneda + ' ' + parseFloat(data.kpiGastos || 0).toFixed(2));

                // Actualizar tabla de stock crítico
                if (data.stockCritico) {
                    actualizarTablaStockCritico(data.stockCritico);
                }

                console.log('[Dashboard Principal] Actualizado a las ' + (data.ultimaActualizacion || new Date().toLocaleTimeString()));
            },
            error: function(xhr) {
                console.log('[Dashboard Principal] Error al actualizar:', xhr.statusText);
            }
        });
    }

    function actualizarTablaStockCritico(productos) {
        var tbody = $('#tbodyStockCritico');
        tbody.empty();

        if (!productos || productos.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center text-muted">¡Excelente! No hay productos con stock crítico.</td></tr>');
            return;
        }

        productos.forEach(function(p) {
            tbody.append(
                '<tr>' +
                    '<td>' + (p.nombre || '') + '</td>' +
                    '<td>' + (p.categoria || '') + '</td>' +
                    '<td class="text-danger font-weight-bold">' + (p.stockActual || 0) + '</td>' +
                    '<td>' + (p.stockMinimo || 0) + '</td>' +
                    '<td><a href="/compras/nueva" class="btn btn-xs btn-primary">Reponer</a></td>' +
                '</tr>'
            );
        });
    }
    /*]]>*/
</script>
</body>
</html>