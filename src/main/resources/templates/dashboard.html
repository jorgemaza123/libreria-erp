<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='dashboard')}"></aside>

    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <h1 class="m-0 text-dark">Panel de Control Financiero</h1>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3 th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiVentasMes, 1, 2)}"></h3>
                                <p>Ventas del Mes</p>
                            </div>
                            <div class="icon"><i class="fas fa-cash-register"></i></div>
                            <a href="/ventas/lista" class="small-box-footer">Ver detalles <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3 th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiCreditos, 1, 2)}"></h3>
                                <p>Cuentas por Cobrar</p>
                            </div>
                            <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                            <a href="/cobranzas" class="small-box-footer">Gestionar Cobros <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3 th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiInventario, 1, 2)}"></h3>
                                <p>Valor del Inventario</p>
                            </div>
                            <div class="icon"><i class="fas fa-boxes"></i></div>
                            <a href="/reportes" class="small-box-footer">Ver reporte <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-secondary">
                            <div class="inner">
                                <h3 th:text="${config.formatoMoneda} + ' ' + ${#numbers.formatDecimal(kpiGastos, 1, 2)}"></h3>
                                <p>Gastos/Compras Mes</p>
                            </div>
                            <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                            <a href="/gastos" class="small-box-footer">Ver gastos <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-navy card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-bar"></i> Balance: Ingresos vs Egresos (6 Meses)</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="chartBalance" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card card-success card-outline">
                            <div class="card-header">
                                <h3 class="card-title">Top Productos</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="chartTop" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-info card-outline">
                            <div class="card-header"><h3 class="card-title">Modalidad de Venta (Global)</h3></div>
                            <div class="card-body">
                                <canvas id="chartModalidad" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card card-danger card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Alerta de Stock Bajo</h3>
                            </div>
                            <div class="card-body table-responsive p-0" style="height: 250px;">
                                <table class="table table-head-fixed text-nowrap table-striped">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Categoría</th>
                                            <th>Stock Actual</th>
                                            <th>Mínimo</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="p : ${stockCritico}">
                                            <td th:text="${p.nombre}"></td>
                                            <td th:text="${p.categoria}"></td>
                                            <td class="text-danger font-weight-bold" th:text="${p.stockActual}"></td>
                                            <td th:text="${p.stockMinimo}"></td>
                                            <td>
                                                <a href="/compras/nueva" class="btn btn-xs btn-primary">Reponer</a>
                                            </td>
                                        </tr>
                                        <tr th:if="${stockCritico.empty}">
                                            <td colspan="5" class="text-center text-muted">¡Excelente! No hay productos con stock crítico.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // 1. DATOS COMPARATIVA
    const rawComparativa = /*[[${comparativa}]]*/ {};
    const labelsComp = Object.keys(rawComparativa);
    const dataIngresos = labelsComp.map(k => rawComparativa[k].ingreso);
    const dataEgresos = labelsComp.map(k => rawComparativa[k].egreso);

    // 2. DATOS TOP
    const rawTop = /*[[${topProductos}]]*/ [];
    
    // 3. DATOS MODALIDAD
    const rawPie = /*[[${pieCredito}]]*/ {};

    $(document).ready(function() {
        
        // GRÁFICO 1: BALANCE (BARRAS) - Colores desde configuración
        new Chart(document.getElementById('chartBalance').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labelsComp,
                datasets: [
                    {
                        label: 'Ingresos (Ventas)',
                        backgroundColor: APP_CONFIG.colorExito,
                        data: dataIngresos
                    },
                    {
                        label: 'Egresos (Gastos/Compras)',
                        backgroundColor: APP_CONFIG.colorPeligro,
                        data: dataEgresos
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{ ticks: { beginAtZero: true, callback: function(value) { return APP_CONFIG.formatoMoneda + ' ' + value; } } }]
                },
                tooltips: {
                    callbacks: { label: function(item) { return APP_CONFIG.formatoMoneda + ' ' + item.yLabel.toFixed(2); } }
                }
            }
        });

        // GRÁFICO 2: TOP PRODUCTOS (DONUT) - Paleta de colores personalizada
        new Chart(document.getElementById('chartTop').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: rawTop.map(d => d.etiqueta),
                datasets: [{
                    data: rawTop.map(d => d.valor),
                    backgroundColor: [
                        APP_CONFIG.colorPeligro,
                        APP_CONFIG.colorExito,
                        APP_CONFIG.colorAdvertencia,
                        APP_CONFIG.colorInfo,
                        APP_CONFIG.colorPrimario
                    ],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, legend: { position: 'right' } }
        });

        // GRÁFICO 3: MODALIDAD (PIE) - Colores desde configuración
        new Chart(document.getElementById('chartModalidad').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Contado', 'Crédito'],
                datasets: [{
                    data: [rawPie.contado, rawPie.credito],
                    backgroundColor: [APP_CONFIG.colorInfo, APP_CONFIG.colorAdvertencia]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    });
    /*]]>*/
</script>
</body>
</html>