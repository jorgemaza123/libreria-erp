<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}"></head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    <aside th:replace="~{fragments/layout :: sidebar(active='servicios')}"></aside>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid"><h1>Nueva Orden de Servicio / Proyecto</h1></div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="card card-navy card-outline">
                    <div class="card-header">
                        <h3 class="card-title">Datos del Proyecto</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label>Tipo Servicio</label>
                                <input type="text" id="tipoServicio" class="form-control" list="listaServicios" placeholder="Ej: REPARACIÓN PC">
                                <datalist id="listaServicios">
    <option th:each="tipo : ${tipos}" th:value="${tipo}"></option>
</datalist>
                            </div>
                            <div class="col-md-6">
                                <label>Título del Trabajo</label>
                                <input type="text" id="tituloTrabajo" class="form-control" placeholder="Ej: Formateo Laptop HP + Office">
                            </div>
                            <div class="col-md-3">
                                <label>Entrega Estimada</label>
                                <input type="date" id="fechaEntrega" class="form-control">
                            </div>
                        </div>

                        <div class="row mt-3 bg-light p-2 rounded">
                            <div class="col-md-5">
                                <label>Cliente</label>
                                <input type="text" id="clienteNombre" class="form-control" placeholder="Nombre Completo">
                            </div>
                            <div class="col-md-3">
                                <label>DNI / RUC</label>
                                <input type="text" id="clienteDoc" class="form-control" placeholder="Documento">
                            </div>
                            <div class="col-md-4">
                                <label>Teléfono</label>
                                <input type="text" id="clienteTel" class="form-control" placeholder="Para avisar por WhatsApp">
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <label>Desglose de Costos (Materiales, Mano de obra, etc.)</label>
                                <table class="table table-bordered table-sm">
                                    <thead class="bg-navy">
                                        <tr>
                                            <th>Descripción de la Tarea / Insumo</th>
                                            <th width="150">Costo (S/)</th>
                                            <th width="50"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyItems">
                                        </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3">
                                                <button class="btn btn-outline-primary btn-sm" onclick="agregarFila()">
                                                    <i class="fas fa-plus"></i> Agregar Tarea/Item
                                                </button>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div class="row justify-content-end mt-3">
                            <div class="col-md-4">
                                <table class="table table-borderless">
                                    <tr>
                                        <th class="text-right">TOTAL PRESUPUESTO:</th>
                                        <td><input type="number" id="total" class="form-control text-right font-weight-bold" readonly value="0.00"></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right text-success">A CUENTA (Adelanto):</th>
                                        <td><input type="number" id="aCuenta" class="form-control text-right border-success" value="0.00" oninput="calcularTotales()"></td>
                                    </tr>
                                    <tr>
                                        <th class="text-right text-danger">SALDO PENDIENTE:</th>
                                        <td class="text-right"><h3 class="text-danger m-0" id="saldo">S/ 0.00</h3></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Observaciones Internas</label>
                            <textarea id="observaciones" class="form-control" rows="2" placeholder="Detalles técnicos, contraseñas, estado del equipo..."></textarea>
                        </div>
                    </div>
                    
                    <div class="card-footer text-right">
                        <button class="btn btn-app bg-success" onclick="guardarOrden()">
                            <i class="fas fa-save"></i> GUARDAR ORDEN
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div th:replace="~{fragments/layout :: scripts}"></div>

<script>
    // Iniciar con una fila
    $(document).ready(function() { agregarFila(); });

    function agregarFila() {
        let html = `
            <tr>
                <td><input type="text" class="form-control item-desc" placeholder="Ej: Mano de obra instalación..."></td>
                <td><input type="number" class="form-control item-costo" value="0.00" step="0.50" oninput="calcularTotales()"></td>
                <td class="text-center"><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove(); calcularTotales();"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        $('#tbodyItems').append(html);
    }

    function calcularTotales() {
        let total = 0;
        $('.item-costo').each(function() { total += parseFloat($(this).val()) || 0; });
        
        let aCuenta = parseFloat($('#aCuenta').val()) || 0;
        
        // Validación visual: Adelanto no puede ser mayor al total
        if(aCuenta > total) {
            $('#aCuenta').addClass('is-invalid');
        } else {
            $('#aCuenta').removeClass('is-invalid');
        }

        let saldo = total - aCuenta;
        
        $('#total').val(total.toFixed(2));
        $('#saldo').text("S/ " + saldo.toFixed(2));
    }

    function guardarOrden() {
        let items = [];
        $('#tbodyItems tr').each(function() {
            let desc = $(this).find('.item-desc').val();
            let costo = parseFloat($(this).find('.item-costo').val()) || 0;
            if(desc.trim() !== "") items.push({ descripcion: desc, costo: costo });
        });

        if(items.length === 0) return Swal.fire('Error', 'Debe agregar al menos una tarea o costo', 'warning');

        let dto = {
            tipoServicio: $('#tipoServicio').val(),
            tituloTrabajo: $('#tituloTrabajo').val(),
            fechaEntrega: $('#fechaEntrega').val(),
            clienteNombre: $('#clienteNombre').val(),
            clienteDocumento: $('#clienteDoc').val(),
            clienteTelefono: $('#clienteTel').val(),
            aCuenta: parseFloat($('#aCuenta').val()) || 0,
            observaciones: $('#observaciones').val(),
            items: items
        };

        $.ajax({
            url: '/ordenes/api/guardar',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dto),
            success: function(resp) {
                Swal.fire('¡Registrado!', `Orden #${resp.id} creada.`, 'success').then(() => {
                    // Opcional: Imprimir ticket de recepción
                    // window.open('/ordenes/pdf/' + resp.id, '_blank');
                    window.location.href = '/ordenes/lista';
                });
            },
            error: function(err) { Swal.fire('Error', 'No se pudo guardar la orden', 'error'); }
        });
    }

    /*[+
    let ordenEdit = [[${ordenEdicion}]];
    if(ordenEdit) {
        // Limpiar tabla vacía
        $('#tbodyItems').empty();
        
        // Llenar campos cabecera
        $('#tipoServicio').val(ordenEdit.tipoServicio);
        $('#tituloTrabajo').val(ordenEdit.tituloTrabajo);
        $('#fechaEntrega').val(ordenEdit.fechaEntregaEstimada);
        $('#clienteNombre').val(ordenEdit.clienteNombre);
        $('#clienteDoc').val(ordenEdit.clienteDocumento);
        $('#clienteTel').val(ordenEdit.clienteTelefono);
        $('#aCuenta').val(ordenEdit.aCuenta);
        $('#observaciones').val(ordenEdit.observaciones);
        
        // Agregar ID oculto para saber que es update (necesitas agregar un input hidden en el HTML)
        // <input type="hidden" id="idOrden" th:value="${ordenEdicion?.id}">
        
        // Llenar filas
        ordenEdit.items.forEach(item => {
            let html = `
            <tr>
                <td><input type="text" class="form-control item-desc" value="${item.descripcion}"></td>
                <td><input type="number" class="form-control item-costo" value="${item.costo}" oninput="calcularTotales()"></td>
                <td class="text-center"><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove(); calcularTotales();"><i class="fas fa-trash"></i></button></td>
            </tr>`;
            $('#tbodyItems').append(html);
        });
        calcularTotales();
    }
+]*/
</script>
</body>
</html>