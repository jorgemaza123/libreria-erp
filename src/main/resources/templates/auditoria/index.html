<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}"
      th:with="active='auditoria'">
<head>
    <title>Auditoría del Sistema</title>
</head>
<body>

<div layout:fragment="content">
    
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-history"></i> Auditoría del Sistema</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                        <li class="breadcrumb-item active">Auditoría</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="filtrosForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Fecha Inicio</label>
                                    <input type="datetime-local" class="form-control" id="fechaInicio" name="fechaInicio">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Fecha Fin</label>
                                    <input type="datetime-local" class="form-control" id="fechaFin" name="fechaFin">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Usuario</label>
                                    <input type="text" class="form-control" id="usuario" name="usuario" placeholder="Todos">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Módulo</label>
                                    <select class="form-control" id="modulo" name="modulo">
                                        <option value="">Todos</option>
                                        <option value="PRODUCTOS">PRODUCTOS</option>
                                        <option value="VENTAS">VENTAS</option>
                                        <option value="COMPRAS">COMPRAS</option>
                                        <option value="CAJA">CAJA</option>
                                        <option value="INVENTARIO">INVENTARIO</option>
                                        <option value="CONFIGURACION">CONFIGURACION</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Acción</label>
                                    <select class="form-control" id="accion" name="accion">
                                        <option value="">Todas</option>
                                        <option value="CREAR">CREAR</option>
                                        <option value="MODIFICAR">MODIFICAR</option>
                                        <option value="ELIMINAR">ELIMINAR</option>
                                        <option value="ANULAR">ANULAR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-right">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                                <button type="button" class="btn btn-secondary" id="btnLimpiar">
                                    <i class="fas fa-eraser"></i> Limpiar
                                </button>
                                <button type="button" class="btn btn-success" id="btnExportar">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list"></i> Resultados</h3>
                    <div class="card-tools">
                        <span class="badge badge-info" id="totalRegistros">0 registros</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 60px">ID</th>
                                    <th style="width: 150px">Fecha/Hora</th>
                                    <th style="width: 100px">Usuario</th>
                                    <th style="width: 120px">Módulo</th>
                                    <th style="width: 100px">Acción</th>
                                    <th style="width: 120px">Entidad</th>
                                    <th style="width: 80px">ID Ent.</th>
                                    <th style="width: 120px">IP</th>
                                    <th>Detalles</th>
                                    <th style="width: 100px">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAuditoria">
                                <tr>
                                    <td colspan="10" class="text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer clearfix">
                    <ul class="pagination pagination-sm m-0 float-right" id="paginacion">
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Detalle de Auditoría</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><th style="width: 40%">ID:</th><td id="detalle-id"></td></tr>
                                <tr><th>Fecha/Hora:</th><td id="detalle-fecha"></td></tr>
                                <tr><th>Usuario:</th><td id="detalle-usuario"></td></tr>
                                <tr><th>Módulo:</th><td id="detalle-modulo"></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Acción:</th><td id="detalle-accion"></td></tr>
                                <tr><th>Entidad:</th><td id="detalle-entidad"></td></tr>
                                <tr><th>ID Entidad:</th><td id="detalle-entidadId"></td></tr>
                                <tr><th>IP:</th><td id="detalle-ip"></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <h6>Detalles Adicionales:</h6>
                            <pre id="detalle-detalles" class="bg-light p-2 border rounded"></pre>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-danger">Valor Anterior:</h6>
                            <pre id="detalle-valorAnterior" class="bg-light p-2 border rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.9em;"></pre>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Valor Nuevo:</h6>
                            <pre id="detalle-valorNuevo" class="bg-light p-2 border rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.9em;"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts">
    <script>
        let currentPage = 0;
        let pageSize = 20;

        $(document).ready(function() {
            buscarAuditorias();

            $('#filtrosForm').on('submit', function(e) {
                e.preventDefault();
                currentPage = 0;
                buscarAuditorias();
            });

            $('#btnLimpiar').on('click', function() {
                $('#filtrosForm')[0].reset();
                currentPage = 0;
                buscarAuditorias();
            });

            $('#btnExportar').on('click', function() {
                exportarExcel();
            });
        });

        function buscarAuditorias() {
            const params = {
                fechaInicio: $('#fechaInicio').val(),
                fechaFin: $('#fechaFin').val(),
                usuario: $('#usuario').val(),
                modulo: $('#modulo').val(),
                accion: $('#accion').val(),
                page: currentPage,
                size: pageSize
            };

            $('#tablaAuditoria').html('<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>');

            $.get('/auditoria/api/buscar', params)
                .done(function(data) {
                    mostrarResultados(data);
                })
                .fail(function() {
                    $('#tablaAuditoria').html('<tr><td colspan="10" class="text-center text-danger">Error al cargar datos</td></tr>');
                });
        }

        function mostrarResultados(data) {
            const tbody = $('#tablaAuditoria');
            tbody.empty();

            if (!data.content || data.content.length === 0) {
                tbody.append('<tr><td colspan="10" class="text-center">No se encontraron registros</td></tr>');
                $('#totalRegistros').text('0 registros');
                $('#paginacion').empty();
                return;
            }

            $('#totalRegistros').text(data.totalElements + ' registros');

            data.content.forEach(function(log) {
                const badgeClass = {
                    'CREAR': 'badge-success',
                    'MODIFICAR': 'badge-warning',
                    'ELIMINAR': 'badge-danger',
                    'ANULAR': 'badge-secondary'
                }[log.accion] || 'badge-info';

                let fechaFormateada = log.fechaHora;
                if (log.fechaHora) {
                    const fecha = new Date(log.fechaHora);
                    fechaFormateada = fecha.toLocaleString('es-PE'); 
                }

                const row = `
                    <tr>
                        <td>${log.id}</td>
                        <td>${fechaFormateada}</td>
                        <td>${log.usuario}</td>
                        <td><span class="badge badge-primary">${log.modulo}</span></td>
                        <td><span class="badge ${badgeClass}">${log.accion}</span></td>
                        <td>${log.entidad || '-'}</td>
                        <td>${log.entidadId || '-'}</td>
                        <td><small>${log.ipAddress || ''}</small></td>
                        <td><small class="text-muted text-truncate d-inline-block" style="max-width: 150px;">${log.detalles || '-'}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verDetalle(${log.id})" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            mostrarPaginacion(data);
        }

        function mostrarPaginacion(data) {
            const paginacion = $('#paginacion');
            paginacion.empty();

            if (data.totalPages <= 1) return;

            const prevDisabled = data.first ? 'disabled' : '';
            paginacion.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="if(!${data.first}) cambiarPagina(${currentPage - 1}); return false;">«</a>
                </li>
            `);

            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(data.totalPages - 1, currentPage + 2);

            if (currentPage < 2) endPage = Math.min(data.totalPages - 1, 4);
            if (currentPage > data.totalPages - 3) startPage = Math.max(0, data.totalPages - 5);

            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                paginacion.append(`
                    <li class="page-item ${activeClass}">
                        <a class="page-link" href="#" onclick="cambiarPagina(${i}); return false;">${i + 1}</a>
                    </li>
                `);
            }

            const nextDisabled = data.last ? 'disabled' : '';
            paginacion.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="if(!${data.last}) cambiarPagina(${currentPage + 1}); return false;">»</a>
                </li>
            `);
        }

        function cambiarPagina(page) {
            currentPage = page;
            buscarAuditorias();
        }

        function verDetalle(id) {
            $.get('/auditoria/api/detalle/' + id)
                .done(function(log) {
                    mostrarDetalleModal(log);
                })
                .fail(function() {
                    if(typeof Swal !== 'undefined') Swal.fire('Error', 'No se pudo cargar el detalle', 'error');
                });
        }

        function mostrarDetalleModal(log) {
            const fecha = new Date(log.fechaHora);
            $('#detalle-id').text(log.id);
            $('#detalle-fecha').text(fecha.toLocaleString('es-PE'));
            $('#detalle-usuario').text(log.usuario);
            $('#detalle-modulo').html('<span class="badge badge-primary">' + log.modulo + '</span>');
            $('#detalle-accion').text(log.accion);
            $('#detalle-entidad').text(log.entidad);
            $('#detalle-entidadId').text(log.entidadId || '-');
            $('#detalle-ip').text(log.ipAddress);
            $('#detalle-detalles').text(log.detalles || '-');

            formatearJsonEnElemento('#detalle-valorAnterior', log.valorAnterior);
            formatearJsonEnElemento('#detalle-valorNuevo', log.valorNuevo);

            $('#modalDetalle').modal('show');
        }

        function formatearJsonEnElemento(selector, jsonString) {
            const elem = $(selector);
            if (!jsonString) {
                elem.text('N/A');
                return;
            }
            try {
                const obj = (typeof jsonString === 'string') ? JSON.parse(jsonString) : jsonString;
                elem.text(JSON.stringify(obj, null, 2));
            } catch (e) {
                elem.text(jsonString);
            }
        }

        function exportarExcel() {
            const params = new URLSearchParams({
                fechaInicio: $('#fechaInicio').val() || '',
                fechaFin: $('#fechaFin').val() || '',
                usuario: $('#usuario').val() || '',
                modulo: $('#modulo').val() || '',
                accion: $('#accion').val() || ''
            });
            window.location.href = '/auditoria/exportar?' + params.toString();
        }
    </script>
</th:block>

</body>
</html>